<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>Vue 中使用 Video.js 播放 RTMP 视频 | 我们在小孩和大人的转角盖一座城堡</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="hpdell"><meta name="designer" content="minfive"><meta name="keywords" content="undefined"><meta name="description" content="HPDell 的博客"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://hpdell.github.io/编程/vue-vidoejs-rtmp/index.html"><link rel="icon" type="image/png" href="/assets/img/avatar.jpg" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="HPDell 的个人博客"><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart=""><div id="page-loading" class="page page-loading" style="background-image:url(undefined)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="HPDell 的个人博客" alt="HPDell 的个人博客"><img src="/assets/img/avatar.jpg" alt="HPDell 的个人博客"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/assets/cover/vue-vidoejs-rtmp.png" alt="Vue 中使用 Video.js 播放 RTMP 视频"></div><header class="post__info"><h1 class="post__title">Vue 中使用 Video.js 播放 RTMP 视频</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">HPDell</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2019-01-19</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Vue/">Vue</a></li><li class="mark__item"><a href="/tags/网页开发/">网页开发</a></li></ul></div></div></header><div class="post__content"><p>香港卫视有直播的 RTMP 流，本文简述了使用 Vue 技术播放 RTMP 流媒体的方法。 <a id="more"></a> 在网页上播放视频或者直播流，比较常用的视频流有很多。可以分为几类技术：</p><ul><li>HTTP 系列。直播采用的是 ogg 格式的流媒体；</li><li>Apple 系列。直播采用的是 HLS 格式的流媒体；</li><li>Flash 系列。直播采用的是 RTMP 格式的流媒体。</li></ul><p>Video.js 库已经将常见的视频流进行了封装，并扩展了 HTML 的视频控件的能力。 因此我们主要使用 Video.js 作为基础进行开发。</p><h1 id="Vue-Video-Player-的改造"><a href="#Vue-Video-Player-的改造" class="headerlink" title="Vue-Video-Player 的改造"></a>Vue-Video-Player 的改造</h1><p>在 Vue 中使用 Video.js 库的时候，常用的库就是 <a href="https://www.npmjs.com/package/vue-video-player" target="_blank" rel="noopener">Vue-Video-Player</a> 这个库。 这个库将 Video.js 封装为 Vue 组件，在 Vue 项目中直接引用即可。 但是这个库在播放 RTMP 格式视频流的时候，会出现问题！我们需要对其进行改造。</p><p>其实这个库最核心的源码就是一个名为 <code>player.vue</code> 的组件。其他文件不过是作为 Vue 插件的必要代码。 因此，我们可以直接将这个组件复制到我们的工程中，以普通组件的方式引入即可。 然后对其进行改造。改造方法如下</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import _videojs from 'video.js'</span><br><span class="line">const videojs = window.videojs || _videojs</span><br><span class="line"><span class="addition">+ import "videojs-flash"</span></span><br></pre></td></tr></table></figure><p>这个库无法播放 RTMP 的根本原因尚不清楚，不过从这个改造方法来看，可能是由于作用域的问题， 导致在外部引入的 <code>videojs-flash</code> 模块无法在这个组件中加载，因此需要将这个模块在组件中引入。 然后运行即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;h1&gt;RTMP Video&lt;/h1&gt;</span><br><span class="line">        &lt;video-player :options=&quot;playerOptions&quot; :playsinline=&quot;true&quot; @statechanged=&quot;playerStateChanged($event)&quot;&gt;&lt;/video-player&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">import VideoPlayer from &quot;./player.vue&quot;</span><br><span class="line">export default &#123;</span><br><span class="line">    components: &#123;</span><br><span class="line">        &quot;video-player&quot;: VideoPlayer</span><br><span class="line">    &#125;,</span><br><span class="line">    data () &#123;</span><br><span class="line">        return &#123;</span><br><span class="line">            playerOptions: &#123;</span><br><span class="line">                sources: [&#123;</span><br><span class="line">                    type: &quot;rtmp/flv&quot;,</span><br><span class="line">                    src: &quot;rtmp://live.hkstv.hk.lxdns.com/live/hks2&quot;</span><br><span class="line">                &#125;],</span><br><span class="line">                techOrder: [&apos;flash&apos;],</span><br><span class="line">                autoplay: true,</span><br><span class="line">                controls: true,</span><br><span class="line">                flash: &#123;</span><br><span class="line">                    swf: &quot;static/video-js.swf&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                height: &quot;320&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        playerStateChanged (state) &#123;</span><br><span class="line">            console.log(state)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    mounted() &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure><h1 id="在-Electron-中播放"><a href="#在-Electron-中播放" class="headerlink" title="在 Electron 中播放"></a>在 Electron 中播放</h1><p>在 Electron 中播放，需要加载 Flash。加载的方法也很简单，将下面代码加入创建窗口之前</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> flashPath = app.getPath(<span class="string">'pepperFlashSystemPlugin'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(flashPath);</span><br><span class="line"></span><br><span class="line">app.commandLine.appendSwitch(<span class="string">"ppapi-flash-path"</span>, flashPath);</span><br><span class="line">app.commandLine.appendSwitch(<span class="string">'ppapi-flash-version'</span>, <span class="string">'29.0.0.013'</span>); <span class="comment">// 可以不要</span></span><br></pre></td></tr></table></figure><p>然后打开 Electron 插件的功能</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mainWindow = new BrowserWindow(&#123;</span><br><span class="line">    height: 563,</span><br><span class="line">    useContentSize: true,</span><br><span class="line"><span class="addition">+   webPreferences: &#123;</span></span><br><span class="line"><span class="addition">+       plugins: true</span></span><br><span class="line"><span class="addition">+   &#125;,</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>然后把 <code>videojs-flash</code> 中提供的 <code>video-js.swf</code> 文件放到 <code>statics</code> 文件夹下即可。 这是我们在 Electron 中使用的效果。</p><img src="/编程/vue-vidoejs-rtmp/electron-rtmp.png"><h2 id="打包模式下的问题"><a href="#打包模式下的问题" class="headerlink" title="打包模式下的问题"></a>打包模式下的问题</h2><p>上述 Electron 应用在打包后，就无法播放 RTMP 视频了。为什么呢？</p><blockquote><p>Electron 应用一旦打包，所有资源的加载都是以 <code>file://</code> 协议进行加载的，这时 Flash 被禁用了。</p></blockquote><p>这是官方的解释。但是其实我试过，直接用 <code>embed</code> 标签从 <code>static</code> 文件夹中加载 swf 文件是可以的。 但是为什么 <code>video-js.swf</code> 就加载不出来，原因就不得而知了。 如果想要加载视频，可以采取将 Electron 编译好的 HTML 文件放到服务器上，如 nginx 。 通过服务器加载 Electron 应用内的页面。</p><p>官方给出的解决方案是，使用 <code>nw-flash-trust</code> 库，信任 Flash 。 但是我至今也没有试出来到底怎么使用这个库。</p><p>经过测试，我实验出了一种打包方法，可以摆脱单独的服务器。原理是采用内置服务器，最简单的方法是用 Express。 在应用程序的主进程中创建一个 Express 服务器，只需要设置静态文件中间件，即可通过服务器加载页面。 在主进程的 <code>index.js</code> 文件中添加如下函数</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">localServer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> server = express();</span><br><span class="line">  server.use(express.static(__dirname));</span><br><span class="line">  server.listen(<span class="number">8888</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后做如下修改：</p><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import express from "express"</span><br><span class="line">let mainWindow</span><br><span class="line">const winURL = process.env.NODE_ENV <span class="comment">=== 'development'</span></span><br><span class="line">  ? `http://localhost:9082`</span><br><span class="line"><span class="deletion">-  : `file://$&#123;__dirname&#125;/index.html`</span></span><br><span class="line"><span class="addition">+  : `http://localhost:8888/index.html`</span></span><br></pre></td></tr></table></figure><figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">function createWindow () &#123;</span><br><span class="line">  /**</span><br><span class="line">   * Initial window options</span><br><span class="line">   */</span><br><span class="line">  mainWindow = new BrowserWindow(&#123;</span><br><span class="line">    height: 563,</span><br><span class="line">    useContentSize: true,</span><br><span class="line">    width: 1000,</span><br><span class="line">    frame: true,</span><br><span class="line">    webPreferences: &#123;</span><br><span class="line">      plugins: true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  mainWindow.loadURL(winURL)</span><br><span class="line"></span><br><span class="line">  mainWindow.webContents.openDevTools()</span><br><span class="line"></span><br><span class="line">  mainWindow.on('closed', () =&gt; &#123;</span><br><span class="line">    mainWindow = null</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line"><span class="addition">+  if (process.env.NODE_ENV === "production") &#123;</span></span><br><span class="line"><span class="addition">+    localServer();</span></span><br><span class="line"><span class="addition">+  &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>然后就可以愉快地在本地播放 RTMP 视频啦。</p><img src="/编程/vue-vidoejs-rtmp/electron-rtmp-express.png"><blockquote><p>这是本地播放视频的效果。 （没想到香港卫视晚上竟然在播《虹猫蓝兔七侠传》系列，童年心痛的回忆啊，央视播了一半被举报然后停播了）</p></blockquote><h1 id="在网页中播放"><a href="#在网页中播放" class="headerlink" title="在网页中播放"></a>在网页中播放</h1><p>由于现在主流浏览器都抛弃了 Flash ，默认关闭 Flash 。而 Video.js 是不会去请求 Flash 权限的。 因此我们需要一个 <code>embed</code> 标签加载一个 swf 文件，通过点击这个标签获取 Flash 权限。 当然，在实际生产中，后续如何处理，就看大家怎么搞了。</p><p>这是我们在网页上获取 Flash 权限之前的效果：</p><img src="/编程/vue-vidoejs-rtmp/web-rtmp-closeflash.png"><p>点击 flash 文件，获取权限，效果如下：</p><img src="/编程/vue-vidoejs-rtmp/web-rtmp-openflash.png"><div class="post-announce">感谢您的阅读，本文由 <a href="http://hpdell.github.io">HPDell 的个人博客</a> 版权所有。如若转载，请注明出处：HPDell 的个人博客（<a href="http://hpdell.github.io/编程/vue-vidoejs-rtmp/">http://hpdell.github.io/编程/vue-vidoejs-rtmp/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/其他/english-postgraduates-subtitles/" title="武汉大学《硕士英语》课视听文件字幕"><i class="iconfont icon-prev"></i>武汉大学《硕士英语》课视听文件字幕</a></div><div class="post__prev post__prev--right"><a href="/随笔/nigeru-wa-haji-daga-yaku-ni-tatsu/" title="《逃避虽可耻但有用》观后感">《逃避虽可耻但有用》观后感<i class="iconfont icon-next"></i></a></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">HPDell 的博客</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/随笔/">随笔</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/编程/">编程</a><span class="block-list-count">12</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/其他/">其他</a><span class="block-list-count">3</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/随笔/nigeru-wa-haji-daga-yaku-ni-tatsu/" title="《逃避虽可耻但有用》观后感"><div class="item__cover"><img src="/assets/cover/nigeru-wa-haji-daga-yaku-ni-tatsu.png" alt="《逃避虽可耻但有用》观后感"></div><div class="item__info"><h3 class="item__title">《逃避虽可耻但有用》观后感</h3><span class="item__text">2019-01-22</span></div></a></li><li class="latest-post-item"><a href="/编程/vue-vidoejs-rtmp/" title="Vue 中使用 Video.js 播放 RTMP 视频"><div class="item__cover"><img src="/assets/cover/vue-vidoejs-rtmp.png" alt="Vue 中使用 Video.js 播放 RTMP 视频"></div><div class="item__info"><h3 class="item__title">Vue 中使用 Video.js 播放 RTMP 视频</h3><span class="item__text">2019-01-19</span></div></a></li><li class="latest-post-item"><a href="/其他/english-postgraduates-subtitles/" title="武汉大学《硕士英语》课视听文件字幕"><div class="item__cover"><img src="/assets/img/header_cover.jpg" alt="武汉大学《硕士英语》课视听文件字幕"></div><div class="item__info"><h3 class="item__title">武汉大学《硕士英语》课视听文件字幕</h3><span class="item__text">2019-01-12</span></div></a></li><li class="latest-post-item"><a href="/编程/latex-travis/" title="利用 Travis-CI 持续集成 LaTeX 文档"><div class="item__cover"><img src="/assets/img/header_cover.jpg" alt="利用 Travis-CI 持续集成 LaTeX 文档"></div><div class="item__info"><h3 class="item__title">利用 Travis-CI 持续集成 LaTeX 文档</h3><span class="item__text">2018-11-30</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Apache-POI/">Apache POI</a></li><li class="tag-item"><a class="tag-link" href="/tags/C/">C#</a></li><li class="tag-item"><a class="tag-link" href="/tags/LaTeX/">LaTeX</a></li><li class="tag-item"><a class="tag-link" href="/tags/Linux/">Linux</a></li><li class="tag-item"><a class="tag-link" href="/tags/Python/">Python</a></li><li class="tag-item"><a class="tag-link" href="/tags/TypeScript/">TypeScript</a></li><li class="tag-item"><a class="tag-link" href="/tags/Vue/">Vue</a></li><li class="tag-item"><a class="tag-link" href="/tags/WPF/">WPF</a></li><li class="tag-item"><a class="tag-link" href="/tags/XAML/">XAML</a></li><li class="tag-item"><a class="tag-link" href="/tags/jQuery-Mobile/">jQuery Mobile</a></li><li class="tag-item"><a class="tag-link" href="/tags/travis/">travis</a></li><li class="tag-item"><a class="tag-link" href="/tags/哈利波特/">哈利波特</a></li><li class="tag-item"><a class="tag-link" href="/tags/影评/">影评</a></li><li class="tag-item"><a class="tag-link" href="/tags/爬虫/">爬虫</a></li><li class="tag-item"><a class="tag-link" href="/tags/网页开发/">网页开发</a></li><li class="tag-item"><a class="tag-link" href="/tags/课程/">课程</a></li><li class="tag-item"><a class="tag-link" href="/tags/路网速度/">路网速度</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">Geography Weighted Modelling Lab of Wuhan University.</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Wuhan University, Luoyu Road, Wuhan, Hubei, China.</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>BinbinLu@whu.edu.cn</span></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var tags=["Vue","网页开发"],gitalk=new Gitalk({clientID:"47d3a0c03f3c07172ecc",clientSecret:"8e0da02c5e757c77b93627a7e380e43a248d001c",repo:"HPDell.github.io",owner:"HPDell",admin:["HPDell"],labels:tags,id:new Date(1547925244e3).getTime()>new Date("2018-02-15").getTime()?md5(location.href):location.href});gitalk.render("comment-container")</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>