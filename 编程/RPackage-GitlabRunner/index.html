<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>使用 GitLab Runner 为 R 包配置持续集成服务 | 我们在小孩和大人的转角盖一座城堡</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="hpdell"><meta name="designer" content="minfive"><meta name="keywords" content="undefined"><meta name="description" content="HPDell 的博客"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://hpdell.github.io/编程/RPackage-GitlabRunner/index.html"><link rel="icon" type="image/png" href="/assets/img/avatar.jpg" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="HPDell 的个人博客"><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart=""><div id="page-loading" class="page page-loading" style="background-image:url(undefined)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="HPDell 的个人博客" alt="HPDell 的个人博客"><img src="/assets/img/avatar.jpg" alt="HPDell 的个人博客"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/assets/img/header_cover.jpg" alt="使用 GitLab Runner 为 R 包配置持续集成服务"></div><header class="post__info"><h1 class="post__title">使用 GitLab Runner 为 R 包配置持续集成服务</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">HPDell</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2020-11-04</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/R/">R</a></li><li class="mark__item"><a href="/tags/GitLab-Runner/">GitLab Runner</a></li></ul></div></div></header><div class="post__content"><h1 id="主要目的"><a href="#主要目的" class="headerlink" title="主要目的"></a>主要目的</h1><p>众所周知，R 是一个跨平台统计软件，支持 Debian Ubuntu Fedora openSUSE Windows macOS 等多种平台。 R 中提供了众多的软件包，以实现各种功能。这些包被托管在 CRAN 上。 我们如果写了自己的软件包，也是要发布到 CRAN 上，但是其要求会特别严格，需要这些包在所有平台上编译通过。 R 提供了一个命令 <code>R CMD check --as-cran</code> 以在本地实现模拟 CRAN 编译环境的测试命令。 如果我们可以配置一个持续集成服务，在我们代码更新后直接在这些平台上进行测试，如果通过了就发布到 CRAN 上， 不仅可以大大减少手动测试的工作量，也能尽早发现错误。</p><h1 id="平台选择"><a href="#平台选择" class="headerlink" title="平台选择"></a>平台选择</h1><p>但问题是，基于什么平台配置这个持续集成服务？</p><p>目前提供持续集成服务的平台非常多，例如 Travis, Jekins, Github, Gitlab …… 这些平台有的可以自己部署，有的只能使用公有服务；有的使用脚本配置，有的基于 Docker 。 面对这么多平台，我们需要考虑到 R 和 R 包编译环境本身的特点：</p><ul><li>与其他软件相比，R 并不那么常用，所以几乎没有现成的 Docker 镜像可以使用；</li><li>检查 R 包所需要的依赖包可能非常多，光是 <code>R CMD check</code> 命令执行所需要的包就有十数个，编译环境的配置比较复杂；</li><li>R 包所需要测试通过的平台比较多，尤其涉及 Windows ，这些平台环境的配置方法也不甚相同。</li></ul><p>最后基本没得选，只剩下了 GitLab Runner ，几乎只有它能同时满足以上条件。 而且我们之前也部署了一个 GitLab ，使用 GitLab Runner 顺理成章。</p><p>但是由于需要测试这么多平台，虽然我们有一个 ESXi 平台，但是创建虚拟机有点太奢侈和复杂了，毕竟 GitLab Runner 也就是个小软件。 我们可以使用 Docker 容器替代虚拟机。使用 Docker 容器，我们只需要下载相应的镜像，创建容器，在容器中配置环境即可。 由于缺乏经验，能力尚不足以直接构建好相应的 R 镜像，因此我们直接下载相应系统的官方镜像，然后在容器中直接配置环境。</p><p>综上，我们选定如下部署路线：</p><ol><li>下载相应系统的镜像，创建容器</li><li>在容器中安装 R 软件</li><li>在容器配置 R 包编译环境</li><li>在容器中安装 GitLab Runner 并进行注册</li><li>在 GitLab 仓库中编写持续集成配置文件</li></ol><p>根据以上路线，我们成功配置好了 5 个 GitLab Runner ，实现了在不同系统上的持续集成。</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/编程/RPackage-GitlabRunner/runner-pipeline.png"><h1 id="部署方法"><a href="#部署方法" class="headerlink" title="部署方法"></a>部署方法</h1><h2 id="创建容器"><a href="#创建容器" class="headerlink" title="创建容器"></a>创建容器</h2><p>下载镜像和创建容器就详解了，网上到处都是资料。 而且由于我们是在群晖中部署的，所以基本只是点了点鼠标。 命令行的方法我就暂时不介绍了。</p><p>所需要注意的是对于 Fedora 系统，为了方便配置 GitLab Runner ，启动脚本请使用 <code>/sbin/init</code> 而不要使用 <code>/bin/bash</code> 以防系统无法启动服务，而且还要使用高级权限运行。</p><h2 id="安装-R-软件"><a href="#安装-R-软件" class="headerlink" title="安装 R 软件"></a>安装 R 软件</h2><p>首先需要安装 R 。在不同系统上安装 R 的方法，都写在 CRAN 中。 这里总结一下 Linux 系统的安装方法，因为 Windows 和 macOS 有图形界面，安装很方便。</p><h3 id="Ubuntu"><a href="#Ubuntu" class="headerlink" title="Ubuntu"></a>Ubuntu</h3><p>修改 apt 源，将以下内容放到 <code>/etc/apt/sources.list</code> （或 <code>/etc/apt/sources.list.d</code> 目录下的文件）中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb http://&lt;CRAN地址&gt;/bin/linux/ubuntu &lt;系统版本代号&gt;-&lt;R版本号&gt;/</span><br></pre></td></tr></table></figure><p>CRAN 地址可以使用官方地址，但是国内速度较慢，不建议使用。可以使用如下镜像地址：</p><ul><li>清华大学： <code>mirrors.tuna.tsinghua.edu.cn/CRAN</code></li><li>GWmodel ： <code>gwmodel.whu.edu.cn/mirrors/CRAN</code></li></ul><p>使用方法就是把后面的域名和路径替换 <code>&lt;CRAN地址&gt;</code> 的部分。</p><p>系统版本代号可以使用命令 <code>cat /etc/os-release</code> 查看，几个 LTS 版本的版号如下</p><table><thead><tr><th>版本号</th><th>系统版本代号</th></tr></thead><tbody><tr><td>20.04</td><td>focal</td></tr><tr><td>18.04</td><td>bionic</td></tr><tr><td>16.04</td><td>xenial</td></tr></tbody></table><p>R 版本号取决于要安装哪个 R 的版本</p><table><thead><tr><th>版本号</th><th>填写内容</th></tr></thead><tbody><tr><td>4.0</td><td>cran40</td></tr><tr><td>3.5, 3.6</td><td>cran35</td></tr></tbody></table><p>例如，如果想使用 GWmodel 的 CRAN 镜像地址，那么就使用如下 apt 源</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">deb http://gwmodel.whu.edu.cn/mirrors/CRAN/bin/linux/ubuntu bionic-cran40/</span><br></pre></td></tr></table></figure><p>然后，认证密钥，使用如下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E298A3A825C0D65DFD57CBB651716619E084DAB9</span><br></pre></td></tr></table></figure><p>之后使用 <code>apt update</code> 和 <code>apt install</code> 即可安装。</p><h3 id="Debian"><a href="#Debian" class="headerlink" title="Debian"></a>Debian</h3><p>安装方法总体和 Ubuntu 一样，但是系统版本代号不太一样，但是一样可以通过 <code>cat /etc/os-release</code> 查看</p><table><thead><tr><th>版本号</th><th>系统版本代号</th></tr></thead><tbody><tr><td>10</td><td>buster</td></tr><tr><td>9</td><td>stretch</td></tr><tr><td>8</td><td>jessie</td></tr></tbody></table><p>然后使用如下命令认证密钥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-key adv --keyserver keys.gnupg.net --recv-key <span class="string">'E19F5F87128899B192B1A2C2AD5F960A256A04AF'</span></span><br></pre></td></tr></table></figure><p>之后同样使用 apt 安装即可。</p><h3 id="openSUSE"><a href="#openSUSE" class="headerlink" title="openSUSE"></a>openSUSE</h3><p>这个安装比较简单，但是我在使用 Leap 15.2 版本的时候总是会卡住，所以最好还是使用 Leap 15.1 或版本。安装方法是运行如下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">VERSION=$(grep <span class="string">"^PRETTY_NAME"</span> /etc/os-release | tr <span class="string">" "</span> <span class="string">"_"</span> | sed -e <span class="string">'s/PRETTY_NAME=//'</span> | sed -e <span class="string">'s/"//g'</span>)</span><br><span class="line">zypper addrepo -f http://download.opensuse.org/repositories/devel\:/languages\:/R\:/patched/<span class="variable">$VERSION</span>/ R-base</span><br><span class="line">zypper install R-base=4.0.3</span><br></pre></td></tr></table></figure><p>指定版本号非常重要，不然会安装 R 3.5 版本。</p><h3 id="Fedora"><a href="#Fedora" class="headerlink" title="Fedora"></a>Fedora</h3><p>这个安装更加简单，官方库自带了 R ，所以直接使用如下命令安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnf install R</span><br></pre></td></tr></table></figure><p>需要注意的是， Fedora 32 和 33 有 4.0 版本的 R ，之前的版本只有 3.6 版本的 R 。</p><h2 id="配置-R-包编译环境"><a href="#配置-R-包编译环境" class="headerlink" title="配置 R 包编译环境"></a>配置 R 包编译环境</h2><p>主要就是安装依赖包了，这个就和要进行持续集成的 R 包本身相关了。 可以直接运行一次 <code>R CMD check</code> 命令查看有哪些依赖包没有安装。</p><p>安装包推荐设置 CRAN 镜像，这时的设置方法是将如下语句放在 Rprofile 文件中（根据使用的镜像不同选择不同的地址）</p><figure class="highlight r"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 清华大学 CRAN 镜像</span></span><br><span class="line">options(<span class="string">"repos"</span> = c(CRAN=<span class="string">"https://mirrors.tuna.tsinghua.edu.cn/CRAN/"</span>))</span><br><span class="line"><span class="comment"># GWmodel CRAN 镜像</span></span><br><span class="line">options(<span class="string">"repos"</span> = c(CRAN=<span class="string">"http://gwmodel.whu.edu.cn/mirrors/CRAN/"</span>))</span><br></pre></td></tr></table></figure><p>如果你的包依赖了 <code>sf</code> 包，那么在各个系统下需要安装如下依赖库（不是在 R 中安装）</p><ul><li>Ubuntu &amp; Debian : libgdal-dev, libudunits2-dev</li><li>Fedora: gdal-devel, libproj-devel, geos-devel, udunits2-devel, sqlite-devel</li><li>openSUSE: gdal-devel, libproj-devel, geos-devel, gdal, proj 然后 udunits2 手动编译安装</li></ul><p>其他依赖库也都是通过包管理器安装，这样 R 包的依赖才能通过。</p><h2 id="安装-GitLab-Runner-并进行注册"><a href="#安装-GitLab-Runner-并进行注册" class="headerlink" title="安装 GitLab Runner 并进行注册"></a>安装 GitLab Runner 并进行注册</h2><p>Windows 和 macOS 系统就不说了，非常简单。 Ubuntu 和 Debian 上也有官方教程，直接可以照着做。 Fedora 和 openSUSE 就会遇到奇奇怪怪的问题，尤其是运行 <code>gitlab-runner install</code> 会报系统不支持。 这里主要总结一下 Linux 系统的。</p><h3 id="Ubuntu-和-Debian-上的安装"><a href="#Ubuntu-和-Debian-上的安装" class="headerlink" title="Ubuntu 和 Debian 上的安装"></a>Ubuntu 和 Debian 上的安装</h3><p>Ubuntu, Debian 可以参考<a href="[gitlab](https://docs.gitlab.com/runner/install/">官方文档</a>)进行安装，推荐使用包管理方式。如果有依赖问题解决以来问题即可。</p><h3 id="Fedora-32-上的安装"><a href="#Fedora-32-上的安装" class="headerlink" title="Fedora 32 上的安装"></a>Fedora 32 上的安装</h3><p>之所以说 Fedora 32 ，因为官方没有明确支持这个版本，支持 Fedora 30 ，但是 Fedora 30 并没有 R 4.0 的包。但是经过实测， Fedora 32 确实可以安装 GitLab Runner 只是要解决一些问题。所以这个方法只保证这个系统有效，其他版本并不保证。</p><p>安装前，容器中可能没有 service 命令，可以通过安装 <code>initscripts</code> 命令进行解决。 此外建议安装 <code>lsb</code> 包。</p><p>还记得一开始说容器的启动脚本要使用 <code>/sbin/init</code> 吗？这使得容易可以启动服务。如果使用 <code>/bin/bash</code> 启动的话，即使装了 service 命令，也可能无法启动服务。</p><p>然后使用官方软件包进行安装</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://packages.gitlab.com/install/repositories/runner/gitlab-runner/script.rpm.sh | bash</span><br><span class="line"><span class="built_in">export</span> GITLAB_RUNNER_DISABLE_SKEL=<span class="literal">true</span></span><br><span class="line">dnf install gitlab-runner</span><br><span class="line">gitlab-runner install</span><br></pre></td></tr></table></figure><p>这样应该就安装好了。</p><h3 id="openSUSE-Leap-15-1-上的安装"><a href="#openSUSE-Leap-15-1-上的安装" class="headerlink" title="openSUSE Leap 15.1 上的安装"></a>openSUSE Leap 15.1 上的安装</h3><p>这个明确的讲，使用的是奇技淫巧，不能保证永远可行。</p><p>首先下载 gitlab-runner 二进制文件并放到 <code>PATH</code> 路径中（架构根据实际情况调整）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl -L --output /usr/<span class="built_in">local</span>/bin/gitlab-runner https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-linux-amd64</span><br></pre></td></tr></table></figure><p>然后安装 <code>initscripts</code> 包，并准备以下文件，可以从 Ubuntu 中复制</p><ul><li><code>/etc/init.d/gitlab-runner</code></li><li><code>/lib/lsb/init-functions</code></li></ul><p>然后建立 <code>/etc/rc.d/rc0.d</code> 文件夹，在其中建立软链接</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /etc/init.d/gitlab-runner /etc/rc.d/rc0.d/K20gitlab-runner</span><br></pre></td></tr></table></figure><p>然后，直接运行 <code>gitlab-runner start</code> 应该就可以启动了。</p><blockquote><p>其实，<code>gitlab-runner install</code> 命令只是创建以下服务，这个过程手动创建也是可以的。 上面就是模拟了手动创建的过程。如果你水平比较高，可以自己写服务启动脚本，就不需要从 Ubuntu 复制了。</p></blockquote><h3 id="GitLab-Runner-的注册"><a href="#GitLab-Runner-的注册" class="headerlink" title="GitLab Runner 的注册"></a>GitLab Runner 的注册</h3><p>注册非常简单，在所有系统上都是一样的，使用如下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner register</span><br></pre></td></tr></table></figure><p>然后程序会问几个问题</p><ol><li>GitLab 网址</li><li>Runner 注册的 Token</li><li>Runner 的名字</li><li>Runner 的标签</li><li>Runner 的运行方式（这里选择 shell ）</li></ol><p>以上问题可以根据<a href="https://docs.gitlab.com/runner/register/" target="_blank" rel="noopener">官方文档</a>进行填写，网上资料也比较多。</p><p>注册完，就可以使用如下命令启动了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitlab-runner start</span><br></pre></td></tr></table></figure><h2 id="在-GitLab-仓库中编写持续集成配置文件"><a href="#在-GitLab-仓库中编写持续集成配置文件" class="headerlink" title="在 GitLab 仓库中编写持续集成配置文件"></a>在 GitLab 仓库中编写持续集成配置文件</h2><p>如何编写持续集成配置文件，是个非常复杂的问题。这篇博客就不详细讲解了。 这里贴出来我们写好的文件，然后提几个注意事项</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">stages:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">build</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">variables:</span></span><br><span class="line"><span class="attr">    GWMODEL_VERSION:</span> <span class="number">2.2</span><span class="bullet">-0</span></span><br><span class="line"></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">    stage:</span> <span class="string">build</span></span><br><span class="line"><span class="attr">    tags:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">GWmodel</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Ubuntu</span></span><br><span class="line"><span class="attr">    only:</span></span><br><span class="line"><span class="attr">        refs:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    script:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">R</span> <span class="string">CMD</span> <span class="string">build</span> <span class="string">GWmodel</span></span><br><span class="line"><span class="attr">    artifacts:</span></span><br><span class="line"><span class="attr">        paths:</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">GWmodel_$GWMODEL_VERSION.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test_cran_ubuntu:</span></span><br><span class="line"><span class="attr">    stage:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">    tags:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">GWmodel</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Ubuntu</span></span><br><span class="line"><span class="attr">    only:</span></span><br><span class="line"><span class="attr">        refs:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    script:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">R</span> <span class="string">CMD</span> <span class="string">check</span> <span class="string">GWmodel_$GWMODEL_VERSION.tar.gz</span> <span class="bullet">--as-cran</span></span><br><span class="line"><span class="attr">    dependencies:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test_cran_debian:</span></span><br><span class="line"><span class="attr">    stage:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">    tags:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">GWmodel</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Debian</span></span><br><span class="line"><span class="attr">    only:</span></span><br><span class="line"><span class="attr">        refs:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    script:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">R</span> <span class="string">CMD</span> <span class="string">check</span> <span class="string">GWmodel_$GWMODEL_VERSION.tar.gz</span> <span class="bullet">--as-cran</span></span><br><span class="line"><span class="attr">    dependencies:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test_cran_openSUSE:</span></span><br><span class="line"><span class="attr">    stage:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">    tags:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">GWmodel</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">openSUSE</span></span><br><span class="line"><span class="attr">    only:</span></span><br><span class="line"><span class="attr">        refs:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    script:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">R</span> <span class="string">CMD</span> <span class="string">check</span> <span class="string">GWmodel_$GWMODEL_VERSION.tar.gz</span> <span class="bullet">--as-cran</span></span><br><span class="line"><span class="attr">    dependencies:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test_cran_Fedora:</span></span><br><span class="line"><span class="attr">    stage:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">    tags:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">GWmodel</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Fedora</span></span><br><span class="line"><span class="attr">    only:</span></span><br><span class="line"><span class="attr">        refs:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    script:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">R</span> <span class="string">CMD</span> <span class="string">check</span> <span class="string">GWmodel_$GWMODEL_VERSION.tar.gz</span> <span class="bullet">--as-cran</span></span><br><span class="line"><span class="attr">    dependencies:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">build</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test_cran_windows:</span></span><br><span class="line"><span class="attr">    stage:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">    tags:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">GWmodel</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Windows</span></span><br><span class="line"><span class="attr">    only:</span></span><br><span class="line"><span class="attr">        refs:</span></span><br><span class="line"><span class="bullet">          -</span> <span class="string">master</span></span><br><span class="line"><span class="attr">    script:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">R.exe</span> <span class="string">CMD</span> <span class="string">check</span> <span class="string">GWmodel_$GWMODEL_VERSION.tar.gz</span> <span class="bullet">--as-cran</span> <span class="bullet">--no-manual</span></span><br><span class="line"><span class="attr">    dependencies:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">build</span></span><br></pre></td></tr></table></figure><h3 id="Stages-和任务"><a href="#Stages-和任务" class="headerlink" title="Stages 和任务"></a>Stages 和任务</h3><p>yml 文件第一级的标签名，默认为是任务名，除非是一些特别的关键字，如 <code>stages</code> 。 这里面标识了不同任务所处的阶段，按顺序排列，名字随意。 只有一个阶段的任务全部通过，才执行下一个阶段的任务。 这里第一个阶段 <code>build</code> 构建一个源码包。这个阶段就无需分系统进行，只有测试才需要分系统进行。</p><h3 id="任务中的-tags"><a href="#任务中的-tags" class="headerlink" title="任务中的 tags"></a>任务中的 tags</h3><p>一个任务执行只使用一个 Runner ，具体使用哪个 Runner ，就是通过 tags 选择的。 所以这里的 tags 要和创建 Runner 时设置的 tags 相对应。</p><h3 id="任务中的-artifacts-和-dependencies"><a href="#任务中的-artifacts-和-dependencies" class="headerlink" title="任务中的 artifacts 和 dependencies"></a>任务中的 artifacts 和 dependencies</h3><p>如果一个任务想留下一些东西给后续任务使用，就需要使用 <code>artifacts</code> 指定留下哪些东西。 这些东西也可以在 GitLab 上进行下载。 这里我留下了 build 命令生成的压缩包，供后续 check 过程使用。</p><p>如果一个任务想使用之前任务留下来的东西，就需要使用 <code>dependencies</code> 指定获取哪些任务遗留下来的文件。 因此，所有执行 <code>test</code> 阶段的任务都依赖于 <code>build</code> 那个任务即可。</p><blockquote><p>其实最后还应该有一步部署，理论上可以直接上传到 CRAN 中。但是这个还没研究出来怎么做，先挖个坑。</p></blockquote><blockquote><p>使用 <code>R CMD check --as-cran</code> 会尝试编译文档，因此需要 latex 。这个最好还是安装以下。 如果不想安装，可以仿照 <code>test_cran_windows</code> 中添加 <code>--no-manual</code> 参数，就不会编译 pdf 版的文档了。</p></blockquote><hr><p>以上就是使用 GitLab Runner 进行 R 包持续集成的所有配置方法。 如有不详细的地方，还请在评论区指出。</p><div class="post-announce">感谢您的阅读，本文由 <a href="http://hpdell.github.io">HPDell 的个人博客</a> 版权所有。如若转载，请注明出处：HPDell 的个人博客（<a href="http://hpdell.github.io/编程/RPackage-GitlabRunner/">http://hpdell.github.io/编程/RPackage-GitlabRunner/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/编程/qgisdev3-spatialweight/" title="QGIS 二次开发笔记（3）——空间距离和空间权重"><i class="iconfont icon-prev"></i>QGIS 二次开发笔记（3）——空间距离和空间权重</a></div><div class="post__prev post__prev--right"><a href="/随笔/genshin-impact-1year/" title="游戏《原神》开服一周年有感">游戏《原神》开服一周年有感<i class="iconfont icon-next"></i></a></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">HPDell 的博客</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/随笔/">随笔</a><span class="block-list-count">9</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/编程/">编程</a><span class="block-list-count">24</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/理论/">理论</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/其他/">其他</a><span class="block-list-count">5</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/编程/dynamic-blog-v2/" title="自己动手写动态博客（二）"><div class="item__cover"><img src="/assets/cover/dynamic-blog-v2.png" alt="自己动手写动态博客（二）"></div><div class="item__info"><h3 class="item__title">自己动手写动态博客（二）</h3><span class="item__text">2022-03-20</span></div></a></li><li class="latest-post-item"><a href="/编程/windows-cmd-mklink/" title="Windows 创建符号链接的命令 mklink"><div class="item__cover"><img src="/assets/img/header_cover.jpg" alt="Windows 创建符号链接的命令 mklink"></div><div class="item__info"><h3 class="item__title">Windows 创建符号链接的命令 mklink</h3><span class="item__text">2022-01-19</span></div></a></li><li class="latest-post-item"><a href="/随笔/wind-from-luoyang/" title="《风起洛阳》观后感"><div class="item__cover"><img src="/assets/cover/wind-from-luoyang.jpg" alt="《风起洛阳》观后感"></div><div class="item__info"><h3 class="item__title">《风起洛阳》观后感</h3><span class="item__text">2021-12-31</span></div></a></li><li class="latest-post-item"><a href="/随笔/only-and-forever/" title="《一生一世》观后感"><div class="item__cover"><img src="/assets/cover/forever-and-ever.jpg" alt="《一生一世》观后感"></div><div class="item__info"><h3 class="item__title">《一生一世》观后感</h3><span class="item__text">2021-11-04</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Apache-POI/">Apache POI</a></li><li class="tag-item"><a class="tag-link" href="/tags/Bootstrap/">Bootstrap</a></li><li class="tag-item"><a class="tag-link" href="/tags/C/">C#</a></li><li class="tag-item"><a class="tag-link" href="/tags/CUDA/">CUDA</a></li><li class="tag-item"><a class="tag-link" href="/tags/Django/">Django</a></li><li class="tag-item"><a class="tag-link" href="/tags/GitLab-Runner/">GitLab Runner</a></li><li class="tag-item"><a class="tag-link" href="/tags/LaTeX/">LaTeX</a></li><li class="tag-item"><a class="tag-link" href="/tags/Linux/">Linux</a></li><li class="tag-item"><a class="tag-link" href="/tags/Node-js/">Node.js</a></li><li class="tag-item"><a class="tag-link" href="/tags/Python/">Python</a></li><li class="tag-item"><a class="tag-link" href="/tags/QGIS/">QGIS</a></li><li class="tag-item"><a class="tag-link" href="/tags/Qt/">Qt</a></li><li class="tag-item"><a class="tag-link" href="/tags/R/">R</a></li><li class="tag-item"><a class="tag-link" href="/tags/TypeScript/">TypeScript</a></li><li class="tag-item"><a class="tag-link" href="/tags/Vue/">Vue</a></li><li class="tag-item"><a class="tag-link" href="/tags/WPF/">WPF</a></li><li class="tag-item"><a class="tag-link" href="/tags/Windows/">Windows</a></li><li class="tag-item"><a class="tag-link" href="/tags/XAML/">XAML</a></li><li class="tag-item"><a class="tag-link" href="/tags/jQuery-Mobile/">jQuery Mobile</a></li><li class="tag-item"><a class="tag-link" href="/tags/travis/">travis</a></li><li class="tag-item"><a class="tag-link" href="/tags/博客相关/">博客相关</a></li><li class="tag-item"><a class="tag-link" href="/tags/原神/">原神</a></li><li class="tag-item"><a class="tag-link" href="/tags/哈利波特/">哈利波特</a></li><li class="tag-item"><a class="tag-link" href="/tags/影评/">影评</a></li><li class="tag-item"><a class="tag-link" href="/tags/测试/">测试</a></li><li class="tag-item"><a class="tag-link" href="/tags/爬虫/">爬虫</a></li><li class="tag-item"><a class="tag-link" href="/tags/电影/">电影</a></li><li class="tag-item"><a class="tag-link" href="/tags/统计学/">统计学</a></li><li class="tag-item"><a class="tag-link" href="/tags/网页开发/">网页开发</a></li><li class="tag-item"><a class="tag-link" href="/tags/课程/">课程</a></li><li class="tag-item"><a class="tag-link" href="/tags/路网速度/">路网速度</a></li><li class="tag-item"><a class="tag-link" href="/tags/随笔/">随笔</a></li></ul></div><div class="sidebar__block__sticky"><h3 class="block__title">目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#主要目的"><span class="toc-text">主要目的</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#平台选择"><span class="toc-text">平台选择</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#部署方法"><span class="toc-text">部署方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建容器"><span class="toc-text">创建容器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装-R-软件"><span class="toc-text">安装 R 软件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ubuntu"><span class="toc-text">Ubuntu</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Debian"><span class="toc-text">Debian</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#openSUSE"><span class="toc-text">openSUSE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fedora"><span class="toc-text">Fedora</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置-R-包编译环境"><span class="toc-text">配置 R 包编译环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装-GitLab-Runner-并进行注册"><span class="toc-text">安装 GitLab Runner 并进行注册</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Ubuntu-和-Debian-上的安装"><span class="toc-text">Ubuntu 和 Debian 上的安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Fedora-32-上的安装"><span class="toc-text">Fedora 32 上的安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#openSUSE-Leap-15-1-上的安装"><span class="toc-text">openSUSE Leap 15.1 上的安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GitLab-Runner-的注册"><span class="toc-text">GitLab Runner 的注册</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#在-GitLab-仓库中编写持续集成配置文件"><span class="toc-text">在 GitLab 仓库中编写持续集成配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Stages-和任务"><span class="toc-text">Stages 和任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#任务中的-tags"><span class="toc-text">任务中的 tags</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#任务中的-artifacts-和-dependencies"><span class="toc-text">任务中的 artifacts 和 dependencies</span></a></li></ol></li></ol></li></ol></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">HPDell的博客，基于Hexo。分享生活，分享技术，分享观点，为自己留下感动。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Wuhan University, Luoyu Road, Wuhan, Hubei, China.</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>huyg0180110559@outlook.com</span></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">友情链接</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://zone.huyg.site/" title="我的动态博客" target="_blank">我的动态博客</a></li><li class="list-item"><a href="https://hkvision.cn/" title="HaoKunT的博客" target="_blank">HaoKunT的博客</a></li><li class="list-item"><a href="https://home.cs-tao.cc/" title="这是一个不能停留太久的世界" target="_blank">CS-Tao</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/HPDell" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:huyg0180110559@outlook.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li><li class="social-network__item"><a href="https://www.zhihu.com/people/hu-yi-gong-63/activities" target="_blank" title="知乎"><i class="iconfont icon-zhihu"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var tags=["R","GitLab Runner"],gitalk=new Gitalk({clientID:"47d3a0c03f3c07172ecc",clientSecret:"8e0da02c5e757c77b93627a7e380e43a248d001c",repo:"HPDell.github.io",owner:"HPDell",admin:["HPDell"],labels:tags,id:new Date(1604522595e3).getTime()>new Date("2018-02-15").getTime()?md5(encodeURI(decodeURI(location.href))):location.href});gitalk.render("comment-container")</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>!function(n){var o=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(t,e){var n=new Image,o=t.getAttribute("data-original");n.onload=function(){t.src=o,e&&e()},n.src=o}function c(){for(var t=0;t<o.length;t++)0<=(e=o[t].getBoundingClientRect()).top&&0<=e.left&&e.top<=(n.innerHeight||document.documentElement.clientHeight)&&i(o[t],function(){o.splice(t,t)});var e;console.log("trigger")}c(),n.addEventListener("scroll",function(){var t,e;t=c,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html>