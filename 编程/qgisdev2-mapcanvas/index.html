<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>QGIS 二次开发笔记（2）——显示图层 | 我们在小孩和大人的转角盖一座城堡</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="hpdell"><meta name="designer" content="minfive"><meta name="keywords" content="undefined"><meta name="description" content="HPDell 的博客"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://hpdell.github.io/编程/qgisdev2-mapcanvas/index.html"><link rel="icon" type="image/png" href="/assets/img/avatar.jpg" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="HPDell 的个人博客"><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart=""><div id="page-loading" class="page page-loading" style="background-image:url(undefined)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="HPDell 的个人博客" alt="HPDell 的个人博客"><img src="/assets/img/avatar.jpg" alt="HPDell 的个人博客"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/assets/img/header_cover.jpg" alt="QGIS 二次开发笔记（2）——显示图层"></div><header class="post__info"><h1 class="post__title">QGIS 二次开发笔记（2）——显示图层</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">HPDell</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2020-07-07</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Qt/">Qt</a></li><li class="mark__item"><a href="/tags/QGIS/">QGIS</a></li></ul></div></div></header><div class="post__content"><p>基于 QGIS 二次开发，最首要的功能就是显示图层。这是个看似非常简单的功能，但是在 QGIS 中写了非常复杂的代码，以支持各种数据源。 但是我们在二次开发中，一般不会支持那么多的数据源。这篇博客首先以 ESRI Shapefile 数据源为例，展示加载图层的过程。</p><p>博客以创建好的工程开始，创建工程的过程网上资料很多，这里就不再赘述了。</p><h1 id="添加地图框"><a href="#添加地图框" class="headerlink" title="添加地图框"></a>添加地图框</h1><p>要想显示图层，首先要有一个显示图层的地方。在 QGIS SDK 中，使用类 <code>QgsMapCanvas</code> 显示地图。这个类需要 QT 中的 svg 组件，即</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># QgsSdkApp.pro</span></span><br><span class="line">QT += core gui xml svg</span><br></pre></td></tr></table></figure><p>如果我们想在 <code>QMainWindow</code> 派生类（我的工程中创建的类名是 <code>QgsSdkApp</code> ，以后直接用这个名称）添加一个 <code>QgsMapCanvas</code> 类型的组件， 有以下三种方法：</p><ol><li>添加插件的方式：在 QT Designer 中添加插件，在 QT Designer 中绘制（我没有实现成功，理论上可以）</li><li>提升类型的方式：在 QT Designer 中使用“提升”功能，将 QWidget 组件提升为 <code>QgsMapCanvas</code> 类型</li><li>手动创建的方式：在 QgsSdkApp.cpp 中手动创建 <code>QgsMapCanvas</code> 类型的对象，添加到窗口中</li></ol><p>下面一一展示。</p><h2 id="提升类型的方式"><a href="#提升类型的方式" class="headerlink" title="提升类型的方式"></a>提升类型的方式</h2><p>选择一个组件，右键单击之后，单击“提升为”按钮，可以弹出提升窗口部件的对话框。</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/编程/qgisdev2-mapcanvas/bootstrap.png"> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/编程/qgisdev2-mapcanvas/bootstrap-dialog.png"><p>上面这个对话框，现在 1 所示的位置输入要提升的类型的名称，然后点击 2 位置上的按钮，在上面的列表上选中刚刚添加的提升类型， 点击 3 位置上的按钮，即可将该组件提升为指定的类型（即 <code>QgsMapCanvas</code> 类型）。</p><p>然后，在 cpp 文件中已经可以访问到这个类型的组件了。</p><h2 id="手动创建的方式"><a href="#手动创建的方式" class="headerlink" title="手动创建的方式"></a>手动创建的方式</h2><p>手动创建的方式就是在窗口类的构造函数中，构造一个 <code>QgsMapCanvas</code> 类型的对象，然后添加到窗口上。 这种情况下和其他在 QT 中手动创建对象没有差别，和其他一样处理即可。</p><h1 id="添加图层"><a href="#添加图层" class="headerlink" title="添加图层"></a>添加图层</h1><p>添加了地图框（在类内使用一个指针 <code>mMapCanvas</code> ，指向这个地图框）之后，下面就可以来添加图层了。 首先以 ESRI Shapefile 为例，介绍一下添加 <code>QgsVectorLayer</code> 的基本方法。</p><h2 id="添加矢量图层的方法"><a href="#添加矢量图层的方法" class="headerlink" title="添加矢量图层的方法"></a>添加矢量图层的方法</h2><blockquote><p>在 QgsSdkApp.ui 中可以添加一个 action ，并拖到工具栏上创建工具按钮。点击这个按钮后开始添加图层。 这个过程网上有很多教程，这里就不再赘述了。</p></blockquote><p>如果要添加 ESRI Shapefile 图层，我们需要先选择这个文件。我们可以直接弹出一个文件选择对话框。 我们以选择的文件路径作为数据源的路径，文件名（不含扩展名）为图层名称。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> QgsSdkApp::on_actionShp_Layer_triggered()</span><br><span class="line">&#123;</span><br><span class="line">    QString filePath = QFileDialog::getOpenFileName(<span class="keyword">this</span>, tr(<span class="string">"Open ESRI Shapefile"</span>), tr(<span class="string">""</span>), tr(<span class="string">"ESRI Shapefile (*.shp)"</span>));</span><br><span class="line">    <span class="function">QFileInfo <span class="title">fileInfo</span><span class="params">(filePath)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (fileInfo.exists())</span><br><span class="line">    &#123;</span><br><span class="line">        QString fileName = fileInfo.baseName();</span><br><span class="line">        addVectorLayer(filePath, fileName, <span class="string">"ogr"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>创建 <code>addVectorLayer()</code> 函数，用于添加图层。我们可以以一种简单的方式添加图层，即直接创建 <code>QgsVectorLayer</code> 对象，并保存到一个列表（<code>mMapLayerList</code>）里。 然后让地图框加载这个列表，即可显示地图。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">QgsVectorLayer *QgsSdkApp::addVectorLayer(<span class="keyword">const</span> QString &amp;vectorLayerPath, <span class="keyword">const</span> QString &amp;name, <span class="keyword">const</span> QString &amp;providerKey, <span class="keyword">bool</span> guiWarning)</span><br><span class="line">&#123;</span><br><span class="line">    QgsVectorLayer* vectorLayer = <span class="keyword">new</span> QgsVectorLayer(uri, layerName, providerKey);</span><br><span class="line">    mMapLayerList.append(vectorLayer);</span><br><span class="line">    mMapCanvas-&gt;setLayers(mMapLayerList);</span><br><span class="line">    <span class="keyword">if</span> (mMapLayerList.size() == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        QgsMapLayer* firstLayer = mMapLayerList.first();</span><br><span class="line">        QgsRectangle extent = mMapCanvas-&gt;mapSettings().layerExtentToOutputExtent(firstLayer, firstLayer-&gt;extent());</span><br><span class="line">        mMapCanvas-&gt;setExtent(extent);</span><br><span class="line">    &#125;</span><br><span class="line">    mMapCanvas-&gt;refresh();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数中除了添加了地图，同时也限制了地图框地显示范围，即设置为第一个图层地显示范围。最后对地图进行了刷新。但是这种方式会遇到很多问题：</p><ol><li>如果将来要设计 Layout ，那么这个地图框的内容无法同步到 Layout 中的地图框中。</li><li>如果图层的投影到地图框的投影有多种转换方式，那么无法选择指定投影方式（尚未实现成功）</li><li>如果图层有子图层，无法选择子图层（ESRI Shapefile 中不会遇到）</li><li>如果图层需要访问验证，无法获取图层（ESRI Shapefile 中不会遇到）</li></ol><p>在 QGIS 中，使用以下代码以较为完善地设置添加地图层，同时支持了很多其他功能。函数中创建的图层直接添加到 <code>QgsProject</code> 中，以支持 Layout 等功能。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">QgsVectorLayer *QgsSdkApp::addVectorLayer(<span class="keyword">const</span> QString &amp;vectorLayerPath, <span class="keyword">const</span> QString &amp;name, <span class="keyword">const</span> QString &amp;providerKey, <span class="keyword">bool</span> guiWarning)</span><br><span class="line">&#123;</span><br><span class="line">    QString baseName = QgsMapLayer::formatLayerName( name );</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Eliminate the need to instantiate the layer based on provider type.</span></span><br><span class="line"><span class="comment">         The caller is responsible for cobbling together the needed information to</span></span><br><span class="line"><span class="comment">         open the layer</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">    QgsDebugMsg( <span class="string">"Creating new vector layer using "</span> + vectorLayerPath</span><br><span class="line">                 + <span class="string">" with baseName of "</span> + baseName</span><br><span class="line">                 + <span class="string">" and providerKey of "</span> + providerKey );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if the layer needs authentication, ensure the master password is set</span></span><br><span class="line">    <span class="keyword">bool</span> authok = <span class="literal">true</span>;</span><br><span class="line">    <span class="function">QRegExp <span class="title">rx</span><span class="params">( <span class="string">"authcfg=([a-z]|[A-Z]|[0-9])&#123;7&#125;"</span> )</span></span>;</span><br><span class="line">    <span class="keyword">if</span> ( rx.indexIn( vectorLayerPath ) != <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        authok = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !QgsAuthGuiUtils::isDisabled( messageBar(), messageTimeout() ) )</span><br><span class="line">        &#123;</span><br><span class="line">            authok = QgsApplication::authManager()-&gt;setMasterPassword( <span class="literal">true</span> );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the layer</span></span><br><span class="line">    QgsVectorLayer::LayerOptions options &#123; QgsProject::instance()-&gt;transformContext() &#125;;</span><br><span class="line">    <span class="comment">// Default style is loaded later in this method</span></span><br><span class="line">    options.loadDefaultStyle = <span class="literal">false</span>;</span><br><span class="line">    QgsVectorLayer *layer = <span class="keyword">new</span> QgsVectorLayer( vectorLayerPath, baseName, providerKey, options );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( authok &amp;&amp; layer &amp;&amp; layer-&gt;isValid() )</span><br><span class="line">    &#123;</span><br><span class="line">        QStringList sublayers = layer-&gt;dataProvider()-&gt;subLayers();</span><br><span class="line">        QgsDebugMsg( QStringLiteral( <span class="string">"got valid layer with %1 sublayers"</span> ).arg( sublayers.count() ) );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If the newly created layer has more than 1 layer of data available, we show the</span></span><br><span class="line">        <span class="comment">// sublayers selection dialog so the user can select the sublayers to actually load.</span></span><br><span class="line">        <span class="keyword">if</span> ( sublayers.count() &gt; <span class="number">1</span> &amp;&amp;</span><br><span class="line">             ! vectorLayerPath.contains( QStringLiteral( <span class="string">"layerid="</span> ) ) &amp;&amp;</span><br><span class="line">             ! vectorLayerPath.contains( QStringLiteral( <span class="string">"layername="</span> ) ) )</span><br><span class="line">        &#123;</span><br><span class="line">            QList&lt; QgsMapLayer * &gt; addedLayers = askUserForOGRSublayers( layer );</span><br><span class="line"></span><br><span class="line">            <span class="comment">// The first layer loaded is not useful in that case. The user can select it in</span></span><br><span class="line">            <span class="comment">// the list if he wants to load it.</span></span><br><span class="line">            <span class="keyword">delete</span> layer;</span><br><span class="line">            layer = addedLayers.isEmpty() ? <span class="literal">nullptr</span> : qobject_cast&lt; QgsVectorLayer * &gt;( addedLayers.at( <span class="number">0</span> ) );</span><br><span class="line">            <span class="keyword">for</span> ( QgsMapLayer *l : addedLayers )</span><br><span class="line">                askUserForDatumTransform( l-&gt;crs(), QgsProject::instance()-&gt;crs(), l );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Register this layer with the layers registry</span></span><br><span class="line">            QList&lt;QgsMapLayer *&gt; myList;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//set friendly name for datasources with only one layer</span></span><br><span class="line">            QStringList sublayers = layer-&gt;dataProvider()-&gt;subLayers();</span><br><span class="line">            <span class="keyword">if</span> ( !sublayers.isEmpty() )</span><br><span class="line">            &#123;</span><br><span class="line">                setupVectorLayer( vectorLayerPath, sublayers, layer,</span><br><span class="line">                                  providerKey, options );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            myList &lt;&lt; layer;</span><br><span class="line">            QgsProject::instance()-&gt;addMapLayers( myList );</span><br><span class="line"></span><br><span class="line">            askUserForDatumTransform( layer-&gt;crs(), QgsProject::instance()-&gt;crs(), layer );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">bool</span> ok;</span><br><span class="line">            layer-&gt;loadDefaultStyle( ok );</span><br><span class="line">            layer-&gt;loadDefaultMetadata( ok );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ( guiWarning )</span><br><span class="line">        &#123;</span><br><span class="line">            QString message = layer-&gt;dataProvider() ? layer-&gt;dataProvider()-&gt;error().message( QgsErrorMessage::Text ) : tr( <span class="string">"Invalid provider"</span> );</span><br><span class="line">            QString msg = tr( <span class="string">"The layer %1 is not a valid layer and can not be added to the map. Reason: %2"</span> ).arg( vectorLayerPath, message );</span><br><span class="line">            visibleMessageBar()-&gt;pushMessage( tr( <span class="string">"Layer is not valid"</span> ), msg, Qgis::Critical, messageTimeout() );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">delete</span> layer;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Let render() do its own cursor management</span></span><br><span class="line">    <span class="comment">//  QApplication::restoreOverrideCursor();</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> layer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>注意其中的 <code>QgsProject::instance()-&gt;addMapLayers( myList );</code> 一行，其实在 QGIS 中所有图层都是通过 <code>QgsProject</code> 进行管理的，一般来说用户无需自己管理。 QGIS SDK 也提供了 <code>QgsLayerTreeView</code> 等一套类，用于显示图层的层级结构，使用也比较方便。 但是如果有一些特别需要的功能，再进行自己管理。</p></blockquote><p>这个函数中还需要其他几个函数，分别定义如下：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line">QList&lt;QgsMapLayer *&gt; QgsSdkApp::askUserForOGRSublayers(QgsVectorLayer *layer)</span><br><span class="line">&#123;</span><br><span class="line">    QList&lt;QgsMapLayer *&gt; result;</span><br><span class="line">    <span class="keyword">if</span> ( !layer )</span><br><span class="line">    &#123;</span><br><span class="line">        layer = qobject_cast&lt;QgsVectorLayer *&gt;( activeLayer() );</span><br><span class="line">        <span class="keyword">if</span> ( !layer || layer-&gt;providerType() != QLatin1String( <span class="string">"ogr"</span> ) )</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    QStringList sublayers = layer-&gt;dataProvider()-&gt;subLayers();</span><br><span class="line"></span><br><span class="line">    QgsSublayersDialog::LayerDefinitionList <span class="built_in">list</span>;</span><br><span class="line">    QMap&lt; QString, <span class="keyword">int</span> &gt; mapLayerNameToCount;</span><br><span class="line">    <span class="keyword">bool</span> uniqueNames = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">int</span> lastLayerId = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> constSublayers = sublayers;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">const</span> QString &amp;sublayer : constSublayers )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// OGR provider returns items in this format:</span></span><br><span class="line">        <span class="comment">// &lt;layer_index&gt;:&lt;name&gt;:&lt;feature_count&gt;:&lt;geom_type&gt;</span></span><br><span class="line"></span><br><span class="line">        QStringList elements = splitSubLayerDef( sublayer );</span><br><span class="line">        <span class="keyword">if</span> ( elements.count() &gt;= <span class="number">4</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            QgsSublayersDialog::LayerDefinition def;</span><br><span class="line">            def.layerId = elements[<span class="number">0</span>].toInt();</span><br><span class="line">            def.layerName = elements[<span class="number">1</span>];</span><br><span class="line">            def.count = elements[<span class="number">2</span>].toInt();</span><br><span class="line">            def.type = elements[<span class="number">3</span>];</span><br><span class="line">            <span class="comment">// ignore geometry column name at elements[4]</span></span><br><span class="line">            <span class="keyword">if</span> ( elements.count() &gt;= <span class="number">6</span> )</span><br><span class="line">                def.description = elements[<span class="number">5</span>];</span><br><span class="line">            <span class="keyword">if</span> ( lastLayerId != def.layerId )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">int</span> count = ++mapLayerNameToCount[def.layerName];</span><br><span class="line">                <span class="keyword">if</span> ( count &gt; <span class="number">1</span> || def.layerName.isEmpty() )</span><br><span class="line">                    uniqueNames = <span class="literal">false</span>;</span><br><span class="line">                lastLayerId = def.layerId;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">list</span> &lt;&lt; def;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            QgsDebugMsg( "Unexpected output from OGR provider's subLayers()! " + sublayer );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Check <span class="keyword">if</span> the current layer uri contains the</span><br><span class="line"></span><br><span class="line">    // We initialize a selection dialog <span class="keyword">and</span> display it.</span><br><span class="line">    QgsSublayersDialog chooseSublayersDialog( QgsSublayersDialog::Ogr, QStringLiteral( "ogr" ), <span class="keyword">this</span> );</span><br><span class="line">    chooseSublayersDialog.setShowAddToGroupCheckbox( <span class="literal">true</span> );</span><br><span class="line">    chooseSublayersDialog.populateLayerTable( <span class="built_in">list</span> );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !chooseSublayersDialog.exec() )</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    QString name = layer-&gt;name();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">auto</span> uriParts = QgsProviderRegistry::instance()-&gt;decodeUri(</span><br><span class="line">                layer-&gt;providerType(), layer-&gt;dataProvider()-&gt;dataSourceUri() );</span><br><span class="line">    <span class="function">QString <span class="title">uri</span><span class="params">( uriParts.value( QStringLiteral( <span class="string">"path"</span> ) ).toString() )</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The uri must contain the actual uri of the vectorLayer from which we are</span></span><br><span class="line">    <span class="comment">// going to load the sublayers.</span></span><br><span class="line">    QString fileName = QFileInfo( uri ).baseName();</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">auto</span> constSelection = chooseSublayersDialog.selection();</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">const</span> QgsSublayersDialog::LayerDefinition &amp;def : constSelection )</span><br><span class="line">    &#123;</span><br><span class="line">        QString layerGeometryType = def.type;</span><br><span class="line">        QString composedURI = uri;</span><br><span class="line">        <span class="keyword">if</span> ( uniqueNames )</span><br><span class="line">        &#123;</span><br><span class="line">            composedURI += <span class="string">"|layername="</span> + def.layerName;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// Only use layerId if there are ambiguities with names</span></span><br><span class="line">            composedURI += <span class="string">"|layerid="</span> + QString::number( def.layerId );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( !layerGeometryType.isEmpty() )</span><br><span class="line">        &#123;</span><br><span class="line">            composedURI += <span class="string">"|geometrytype="</span> + layerGeometryType;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        QgsDebugMsg( <span class="string">"Creating new vector layer using "</span> + composedURI );</span><br><span class="line">        QString name = fileName + <span class="string">" "</span> + def.layerName;</span><br><span class="line">        QgsVectorLayer::LayerOptions options &#123; QgsProject::instance()-&gt;transformContext() &#125;;</span><br><span class="line">        options.loadDefaultStyle = <span class="literal">false</span>;</span><br><span class="line">        QgsVectorLayer *layer = <span class="keyword">new</span> QgsVectorLayer( composedURI, name, QStringLiteral( <span class="string">"ogr"</span> ), options );</span><br><span class="line">        <span class="keyword">if</span> ( layer &amp;&amp; layer-&gt;isValid() )</span><br><span class="line">        &#123;</span><br><span class="line">            result &lt;&lt; layer;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            QString msg = tr( <span class="string">"%1 is not a valid or recognized data source"</span> ).arg( composedURI );</span><br><span class="line">            visibleMessageBar()-&gt;pushMessage( tr( <span class="string">"Invalid Data Source"</span> ), msg, Qgis::Critical, messageTimeout() );</span><br><span class="line">            <span class="keyword">delete</span> layer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !result.isEmpty() )</span><br><span class="line">    &#123;</span><br><span class="line">        QgsSettings settings;</span><br><span class="line">        <span class="keyword">bool</span> addToGroup = settings.value( QStringLiteral( <span class="string">"/qgis/openSublayersInGroup"</span> ), <span class="literal">true</span> ).toBool();</span><br><span class="line">        <span class="keyword">bool</span> newLayersVisible = settings.value( QStringLiteral( <span class="string">"/qgis/new_layers_visible"</span> ), <span class="literal">true</span> ).toBool();</span><br><span class="line">        QgsLayerTreeGroup *group = <span class="literal">nullptr</span>;</span><br><span class="line">        <span class="keyword">if</span> ( addToGroup )</span><br><span class="line">            group = QgsProject::instance()-&gt;layerTreeRoot()-&gt;insertGroup( <span class="number">0</span>, name );</span><br><span class="line"></span><br><span class="line">        QgsProject::instance()-&gt;addMapLayers( result, ! addToGroup );</span><br><span class="line">        <span class="keyword">for</span> ( QgsMapLayer *l : qgis::as_const( result ) )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">bool</span> ok;</span><br><span class="line">            l-&gt;loadDefaultStyle( ok );</span><br><span class="line">            l-&gt;loadDefaultMetadata( ok );</span><br><span class="line">            <span class="keyword">if</span> ( addToGroup )</span><br><span class="line">                group-&gt;addLayer( l );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Respect if user don't want the new group of layers visible.</span></span><br><span class="line">        <span class="keyword">if</span> ( addToGroup &amp;&amp; ! newLayersVisible )</span><br><span class="line">            group-&gt;setItemVisibilityCheckedRecursive( newLayersVisible );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> QgsSdkApp::askUserForDatumTransform(<span class="keyword">const</span> QgsCoordinateReferenceSystem &amp;sourceCrs, <span class="keyword">const</span> QgsCoordinateReferenceSystem &amp;destinationCrs, <span class="keyword">const</span> QgsMapLayer *layer)</span><br><span class="line">&#123;</span><br><span class="line">    Q_ASSERT( qApp-&gt;thread() == QThread::currentThread() );</span><br><span class="line"></span><br><span class="line">    QString title;</span><br><span class="line">    <span class="keyword">if</span> ( layer )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// try to make a user-friendly (short!) identifier for the layer</span></span><br><span class="line">        QString layerIdentifier;</span><br><span class="line">        <span class="keyword">if</span> ( !layer-&gt;name().isEmpty() )</span><br><span class="line">        &#123;</span><br><span class="line">            layerIdentifier = layer-&gt;name();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">const</span> QVariantMap parts = QgsProviderRegistry::instance()-&gt;decodeUri( layer-&gt;providerType(), layer-&gt;source() );</span><br><span class="line">            <span class="keyword">if</span> ( parts.contains( QStringLiteral( <span class="string">"path"</span> ) ) )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="function"><span class="keyword">const</span> QFileInfo <span class="title">fi</span><span class="params">( parts.value( QStringLiteral( <span class="string">"path"</span> ) ).toString() )</span></span>;</span><br><span class="line">                layerIdentifier = fi.fileName();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ( layer-&gt;dataProvider() )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">const</span> QgsDataSourceUri uri( layer-&gt;source() );</span><br><span class="line">                layerIdentifier = uri.table();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( !layerIdentifier.isEmpty() )</span><br><span class="line">            title = tr( <span class="string">"Select Transformation for %1"</span> ).arg( layerIdentifier );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> QgsDatumTransformDialog::run( sourceCrs, destinationCrs, <span class="keyword">this</span>, mMapCanvas, title );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> QStringList <span class="title">splitSubLayerDef</span><span class="params">( <span class="keyword">const</span> QString &amp;subLayerDef )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> subLayerDef.split( QgsDataProvider::sublayerSeparator() );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setupVectorLayer</span><span class="params">( <span class="keyword">const</span> QString &amp;vectorLayerPath,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">const</span> QStringList &amp;sublayers,</span></span></span><br><span class="line"><span class="function"><span class="params">                              QgsVectorLayer *&amp;layer,</span></span></span><br><span class="line"><span class="function"><span class="params">                              <span class="keyword">const</span> QString &amp;providerKey,</span></span></span><br><span class="line"><span class="function"><span class="params">                              QgsVectorLayer::LayerOptions options )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//set friendly name for datasources with only one layer</span></span><br><span class="line">    QgsSettings settings;</span><br><span class="line">    QStringList elements = splitSubLayerDef( sublayers.at( <span class="number">0</span> ) );</span><br><span class="line">    QString rawLayerName = elements.size() &gt;= <span class="number">2</span> ? elements.at( <span class="number">1</span> ) : QString();</span><br><span class="line">    QString subLayerNameFormatted = rawLayerName;</span><br><span class="line">    <span class="keyword">if</span> ( settings.value( QStringLiteral( <span class="string">"qgis/formatLayerName"</span> ), <span class="literal">false</span> ).toBool() )</span><br><span class="line">    &#123;</span><br><span class="line">        subLayerNameFormatted =  QgsMapLayer::formatLayerName( subLayerNameFormatted );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( elements.size() &gt;= <span class="number">4</span> &amp;&amp; layer-&gt;name().compare( rawLayerName, Qt::CaseInsensitive ) != <span class="number">0</span></span><br><span class="line">         &amp;&amp; layer-&gt;name().compare( subLayerNameFormatted, Qt::CaseInsensitive ) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        layer-&gt;setName( QStringLiteral( <span class="string">"%1 %2"</span> ).arg( layer-&gt;name(), rawLayerName ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Systematically add a layername= option to OGR datasets in case</span></span><br><span class="line">    <span class="comment">// the current single layer dataset becomes layer a multi-layer one.</span></span><br><span class="line">    <span class="comment">// Except for a few select extensions, known to be always single layer dataset.</span></span><br><span class="line">    <span class="function">QFileInfo <span class="title">fi</span><span class="params">( vectorLayerPath )</span></span>;</span><br><span class="line">    QString ext = fi.suffix().toLower();</span><br><span class="line">    <span class="keyword">if</span> ( providerKey == QLatin1String( <span class="string">"ogr"</span> ) &amp;&amp;</span><br><span class="line">         ext != QLatin1String( <span class="string">"shp"</span> ) &amp;&amp;</span><br><span class="line">         ext != QLatin1String( <span class="string">"mif"</span> ) &amp;&amp;</span><br><span class="line">         ext != QLatin1String( <span class="string">"tab"</span> ) &amp;&amp;</span><br><span class="line">         ext != QLatin1String( <span class="string">"csv"</span> ) &amp;&amp;</span><br><span class="line">         ext != QLatin1String( <span class="string">"geojson"</span> ) &amp;&amp;</span><br><span class="line">         ! vectorLayerPath.contains( QStringLiteral( <span class="string">"layerid="</span> ) ) &amp;&amp;</span><br><span class="line">         ! vectorLayerPath.contains( QStringLiteral( <span class="string">"layername="</span> ) ) )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">auto</span> uriParts = QgsProviderRegistry::instance()-&gt;decodeUri(</span><br><span class="line">                    layer-&gt;providerType(), layer-&gt;dataProvider()-&gt;dataSourceUri() );</span><br><span class="line">        <span class="function">QString <span class="title">composedURI</span><span class="params">( uriParts.value( QStringLiteral( <span class="string">"path"</span> ) ).toString() )</span></span>;</span><br><span class="line">        composedURI += <span class="string">"|layername="</span> + rawLayerName;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">auto</span> newLayer = qgis::make_unique&lt;QgsVectorLayer&gt;( composedURI, layer-&gt;name(), QStringLiteral( <span class="string">"ogr"</span> ), options );</span><br><span class="line">        <span class="keyword">if</span> ( newLayer &amp;&amp; newLayer-&gt;isValid() )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">delete</span> layer;</span><br><span class="line">            layer = newLayer.release();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数中还需要以下几个 Getter 函数，我们在窗口中提供对应的组件即可：</p><ol><li><code>QgsMessageBar* messageBar()</code> : 可以在状态栏上创建一个 <code>QgsMessageBar</code> 的对象，用这个函数获取</li><li><code>int messageTimeout()</code> : 可以直接返回 500 ，或根据配置文件、设置等返回</li><li><code>QgsMessageBar* visibleMessageBar()</code> : 可直接返回状态栏上的 <code>QgsMessageBar</code> 对象</li><li><code>QgsMapLayer* activeLayer()</code> : 需要使用 <code>QgsLayerTreeView</code> 类获取，下面详述</li></ol><p>但是现在，还不能在地图上显示，需要将 <code>QgsMapCanvas</code> 和 <code>QgsProject</code> 建立关联，才能将 <code>QgsProject</code> 中的图层同步到 <code>QgsMapCanvas</code> 中。 使用的方法是在构造函数中添加如下代码：</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">QgsSdkApp::QgsSdkApp(QWidget *parent)</span><br><span class="line">    : QMainWindow(parent)</span><br><span class="line">    , ui(<span class="keyword">new</span> Ui::QgsSdkApp)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;setupUi(<span class="keyword">this</span>);</span><br><span class="line">    mMapCanvas = ui-&gt;centralwidget;</span><br><span class="line">    mMapCanvas-&gt;setObjectName(QStringLiteral(<span class="string">"theMapCanvas"</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** [BEGIN] 添加的用于将 `QgsMapCanvas` 和 `QgsProject` 建立关联的代码 */</span></span><br><span class="line">    mLayerTreeCanvasBridge = <span class="keyword">new</span> QgsLayerTreeMapCanvasBridge(QgsProject::instance()-&gt;layerTreeRoot(), mMapCanvas, <span class="keyword">this</span>);</span><br><span class="line">    <span class="comment">/** [END] */</span></span><br><span class="line"></span><br><span class="line">    connect(ui-&gt;actionAdd_Shp_Layer, &amp;QAction::triggered, <span class="keyword">this</span>, &amp;QgsSdkApp::on_actionShp_Layer_triggered);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样添加了图层之后，就可以在地图上显示了。</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/编程/qgisdev2-mapcanvas/load-layer.png"><h2 id="添加其他图层"><a href="#添加其他图层" class="headerlink" title="添加其他图层"></a>添加其他图层</h2><p>其他图层的添加方法，都可以从 QGIS 的代码中进行参考。在 qgisapp.cpp 文件中，有这个函数</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> QgisApp::dataSourceManager( <span class="keyword">const</span> QString &amp;pageName )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( ! mDataSourceManagerDialog )</span><br><span class="line">  &#123;</span><br><span class="line">    mDataSourceManagerDialog = <span class="keyword">new</span> QgsDataSourceManagerDialog( mBrowserModel, <span class="keyword">this</span>, mapCanvas() );</span><br><span class="line">    connect( <span class="keyword">this</span>, &amp;QgisApp::connectionsChanged, mDataSourceManagerDialog, &amp;QgsDataSourceManagerDialog::refresh );</span><br><span class="line">    connect( mDataSourceManagerDialog, &amp;QgsDataSourceManagerDialog::connectionsChanged, <span class="keyword">this</span>, &amp;QgisApp::connectionsChanged );</span><br><span class="line">    connect( mDataSourceManagerDialog, SIGNAL( addRasterLayer( QString <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp; ) ),</span><br><span class="line">             <span class="keyword">this</span>, SLOT( addRasterLayer( QString <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp; ) ) );</span><br><span class="line">    connect( mDataSourceManagerDialog, SIGNAL( addVectorLayer( QString <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp; ) ),</span><br><span class="line">             <span class="keyword">this</span>, SLOT( addVectorLayer( QString <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp; ) ) );</span><br><span class="line">    connect( mDataSourceManagerDialog, SIGNAL( addVectorLayers( QStringList <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp; ) ),</span><br><span class="line">             <span class="keyword">this</span>, SLOT( addVectorLayers( QStringList <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp;, QString <span class="keyword">const</span> &amp; ) ) );</span><br><span class="line">    connect( mDataSourceManagerDialog, &amp;QgsDataSourceManagerDialog::addMeshLayer, <span class="keyword">this</span>, &amp;QgisApp::addMeshLayer );</span><br><span class="line">    connect( mDataSourceManagerDialog, &amp;QgsDataSourceManagerDialog::showStatusMessage, <span class="keyword">this</span>, &amp;QgisApp::showStatusMessage );</span><br><span class="line">    connect( mDataSourceManagerDialog, &amp;QgsDataSourceManagerDialog::addDatabaseLayers, <span class="keyword">this</span>, &amp;QgisApp::addDatabaseLayers );</span><br><span class="line">    connect( mDataSourceManagerDialog, &amp;QgsDataSourceManagerDialog::replaceSelectedVectorLayer, <span class="keyword">this</span>, &amp;QgisApp::replaceSelectedVectorLayer );</span><br><span class="line">    connect( mDataSourceManagerDialog, <span class="keyword">static_cast</span>&lt;<span class="keyword">void</span> ( QgsDataSourceManagerDialog::* )()&gt;( &amp;QgsDataSourceManagerDialog::addRasterLayer ), <span class="keyword">this</span>, <span class="keyword">static_cast</span>&lt;<span class="keyword">void</span> ( QgisApp::* )()&gt;( &amp;QgisApp::addRasterLayer ) );</span><br><span class="line">    connect( mDataSourceManagerDialog, &amp;QgsDataSourceManagerDialog::handleDropUriList, <span class="keyword">this</span>, &amp;QgisApp::handleDropUriList );</span><br><span class="line">    connect( <span class="keyword">this</span>, &amp;QgisApp::newProject, mDataSourceManagerDialog, &amp;QgsDataSourceManagerDialog::updateProjectHome );</span><br><span class="line">    connect( mDataSourceManagerDialog, &amp;QgsDataSourceManagerDialog::openFile, <span class="keyword">this</span>, &amp;QgisApp::openFile );</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    mDataSourceManagerDialog-&gt;reset();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Try to open the dialog on a particular page</span></span><br><span class="line">  <span class="keyword">if</span> ( ! pageName.isEmpty() )</span><br><span class="line">  &#123;</span><br><span class="line">    mDataSourceManagerDialog-&gt;openPage( pageName );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( QgsSettings().value( QStringLiteral( <span class="string">"/qgis/dataSourceManagerNonModal"</span> ), <span class="literal">true</span> ).toBool() )</span><br><span class="line">  &#123;</span><br><span class="line">    mDataSourceManagerDialog-&gt;show();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    mDataSourceManagerDialog-&gt;exec();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个函数中有 <code>addRasterLayer</code> <code>addVectorLayer</code> <code>addMeshLayer</code> 等函数，是添加不同类型的图层的方法。可以直接查看这些方法，学习其中的方法，放到工程中来。</p><blockquote><p>在下篇博客中，我计划介绍添加 CSV 类型数据的方法。</p></blockquote><h1 id="显示图层树"><a href="#显示图层树" class="headerlink" title="显示图层树"></a>显示图层树</h1><p>一般情况下我们都需要使用图层树来对图层进行管理。下面我们就在界面上添加 <code>QgsLayerTreeView</code> 对象。</p><p>我们首先在界面上创建一个 QWidget 组件，提升为 <code>QgsLayerTreeView</code> 类型。然后再构造函数中给其设置 Model 等。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">QgsSdkApp::QgsSdkApp(QWidget *parent) : QMainWindow(parent), ui(<span class="keyword">new</span> Ui::QgsSdkApp)</span><br><span class="line">&#123;</span><br><span class="line">    ui-&gt;setupUi(<span class="keyword">this</span>);</span><br><span class="line">    mMapCanvas = ui-&gt;centralwidget;</span><br><span class="line">    mMapCanvas-&gt;setObjectName(QStringLiteral(<span class="string">"theMapCanvas"</span>));</span><br><span class="line">    mLayerTreeCanvasBridge = <span class="keyword">new</span> QgsLayerTreeMapCanvasBridge(QgsProject::instance()-&gt;layerTreeRoot(), mMapCanvas, <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** [BEGIN] 设置 QgsLayerTreeView 的 Model */</span></span><br><span class="line">    QgsLayerTreeModel* model = <span class="keyword">new</span> QgsLayerTreeModel(QgsProject::instance()-&gt;layerTreeRoot(), <span class="keyword">this</span>);</span><br><span class="line">    ui-&gt;layerTreeView-&gt;setModel(model);</span><br><span class="line">    ui-&gt;layerTreeView-&gt;setObjectName(QStringLiteral( <span class="string">"theLayerTreeView"</span> ));</span><br><span class="line">    <span class="comment">/** [END] */</span></span><br><span class="line"></span><br><span class="line">    mInfoBar = <span class="keyword">new</span> QgsMessageBar(<span class="keyword">this</span>);</span><br><span class="line">    ui-&gt;statusbar-&gt;addWidget(mInfoBar);</span><br><span class="line"></span><br><span class="line">    connect(ui-&gt;actionAdd_Shp_Layer, &amp;QAction::triggered, <span class="keyword">this</span>, &amp;QgsSdkApp::on_actionShp_Layer_triggered);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>QT 中采用的 MVC 模型。 QT 中提供了 QTreeView 、 QListView 、 QTableView 等视图（View）， 也提供了 QAbstractItemModel 、 QAbstractListModel 、 QAbstractTableModel 三种模型（Model）， 也会提供了一些 Delegate 委托（相当于控制器 Controller）。</p></blockquote><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/编程/qgisdev2-mapcanvas/layer-tree-view.png"><p>但是我们这个图层树仅仅有一个最基本的功能，而在 QGIS 中排序、右键菜单丰富的功能。 对于右键菜单，QGIS 中使用了 Provider 的方式提供右键菜单的菜单项，我们需要将这些 Provider 的代码复制过来，添加到工程中。</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// qgisapp.cpp [4493行]</span></span><br><span class="line">mLayerTreeView-&gt;setMenuProvider( <span class="keyword">new</span> QgsAppLayerTreeViewMenuProvider( mLayerTreeView, mMapCanvas ) );</span><br></pre></td></tr></table></figure><p>对于排序等其他功能，我们可以按需添加。</p><div class="post-announce">感谢您的阅读，本文由 <a href="http://hpdell.github.io">HPDell 的个人博客</a> 版权所有。如若转载，请注明出处：HPDell 的个人博客（<a href="http://hpdell.github.io/编程/qgisdev2-mapcanvas/">http://hpdell.github.io/编程/qgisdev2-mapcanvas/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/编程/qgisdev1-build/" title="QGIS 二次开发笔记（1）——环境配置"><i class="iconfont icon-prev"></i>QGIS 二次开发笔记（1）——环境配置</a></div><div class="post__prev post__prev--right"><a href="/uncategorized/qgisdev3-spatialweight/" title="QGIS 二次开发笔记（3）——空间距离和空间权重">QGIS 二次开发笔记（3）——空间距离和空间权重<i class="iconfont icon-next"></i></a></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">HPDell 的博客</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/随笔/">随笔</a><span class="block-list-count">6</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/编程/">编程</a><span class="block-list-count">20</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/理论/">理论</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/其他/">其他</a><span class="block-list-count">5</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/uncategorized/qgisdev3-spatialweight/" title="QGIS 二次开发笔记（3）——空间距离和空间权重"><div class="item__cover"><img src="/assets/img/header_cover.jpg" alt="QGIS 二次开发笔记（3）——空间距离和空间权重"></div><div class="item__info"><h3 class="item__title">QGIS 二次开发笔记（3）——空间距离和空间权重</h3><span class="item__text">2020-08-12</span></div></a></li><li class="latest-post-item"><a href="/编程/qgisdev2-mapcanvas/" title="QGIS 二次开发笔记（2）——显示图层"><div class="item__cover"><img src="/assets/img/header_cover.jpg" alt="QGIS 二次开发笔记（2）——显示图层"></div><div class="item__info"><h3 class="item__title">QGIS 二次开发笔记（2）——显示图层</h3><span class="item__text">2020-07-07</span></div></a></li><li class="latest-post-item"><a href="/编程/qgisdev1-build/" title="QGIS 二次开发笔记（1）——环境配置"><div class="item__cover"><img src="/assets/img/header_cover.jpg" alt="QGIS 二次开发笔记（1）——环境配置"></div><div class="item__info"><h3 class="item__title">QGIS 二次开发笔记（1）——环境配置</h3><span class="item__text">2020-03-28</span></div></a></li><li class="latest-post-item"><a href="/随笔/test-stackedit/" title="测试使用 StackEdit  更新博客"><div class="item__cover"><img src="/assets/img/header_cover.jpg" alt="测试使用 StackEdit  更新博客"></div><div class="item__info"><h3 class="item__title">测试使用 StackEdit 更新博客</h3><span class="item__text">2020-01-09</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Apache-POI/">Apache POI</a></li><li class="tag-item"><a class="tag-link" href="/tags/C/">C#</a></li><li class="tag-item"><a class="tag-link" href="/tags/CUDA/">CUDA</a></li><li class="tag-item"><a class="tag-link" href="/tags/LaTeX/">LaTeX</a></li><li class="tag-item"><a class="tag-link" href="/tags/Linux/">Linux</a></li><li class="tag-item"><a class="tag-link" href="/tags/Node-js/">Node.js</a></li><li class="tag-item"><a class="tag-link" href="/tags/Python/">Python</a></li><li class="tag-item"><a class="tag-link" href="/tags/QGIS/">QGIS</a></li><li class="tag-item"><a class="tag-link" href="/tags/Qt/">Qt</a></li><li class="tag-item"><a class="tag-link" href="/tags/R/">R</a></li><li class="tag-item"><a class="tag-link" href="/tags/TypeScript/">TypeScript</a></li><li class="tag-item"><a class="tag-link" href="/tags/Vue/">Vue</a></li><li class="tag-item"><a class="tag-link" href="/tags/WPF/">WPF</a></li><li class="tag-item"><a class="tag-link" href="/tags/XAML/">XAML</a></li><li class="tag-item"><a class="tag-link" href="/tags/jQuery-Mobile/">jQuery Mobile</a></li><li class="tag-item"><a class="tag-link" href="/tags/travis/">travis</a></li><li class="tag-item"><a class="tag-link" href="/tags/博客相关/">博客相关</a></li><li class="tag-item"><a class="tag-link" href="/tags/哈利波特/">哈利波特</a></li><li class="tag-item"><a class="tag-link" href="/tags/影评/">影评</a></li><li class="tag-item"><a class="tag-link" href="/tags/测试/">测试</a></li><li class="tag-item"><a class="tag-link" href="/tags/爬虫/">爬虫</a></li><li class="tag-item"><a class="tag-link" href="/tags/电影/">电影</a></li><li class="tag-item"><a class="tag-link" href="/tags/统计学/">统计学</a></li><li class="tag-item"><a class="tag-link" href="/tags/网页开发/">网页开发</a></li><li class="tag-item"><a class="tag-link" href="/tags/课程/">课程</a></li><li class="tag-item"><a class="tag-link" href="/tags/路网速度/">路网速度</a></li><li class="tag-item"><a class="tag-link" href="/tags/随笔/">随笔</a></li></ul></div><div class="sidebar__block__sticky"><h3 class="block__title">目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#添加地图框"><span class="toc-text">添加地图框</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#提升类型的方式"><span class="toc-text">提升类型的方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#手动创建的方式"><span class="toc-text">手动创建的方式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#添加图层"><span class="toc-text">添加图层</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#添加矢量图层的方法"><span class="toc-text">添加矢量图层的方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加其他图层"><span class="toc-text">添加其他图层</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#显示图层树"><span class="toc-text">显示图层树</span></a></li></ol></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">HPDell的博客，基于Hexo。分享生活，分享技术，分享观点，为自己留下感动。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Wuhan University, Luoyu Road, Wuhan, Hubei, China.</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>huyg0180110559@outlook.com</span></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">友情链接</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://zone.huyg.site/" title="我的动态博客" target="_blank">我的动态博客</a></li><li class="list-item"><a href="https://hkvision.cn/" title="HaoKunT的博客" target="_blank">HaoKunT的博客</a></li><li class="list-item"><a href="https://home.cs-tao.cc/" title="这是一个不能停留太久的世界" target="_blank">CS-Tao</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/HPDell" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:huyg0180110559@outlook.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li><li class="social-network__item"><a href="https://www.zhihu.com/people/hu-yi-gong-63/activities" target="_blank" title="知乎"><i class="iconfont icon-zhihu"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var tags=["Qt","QGIS"],gitalk=new Gitalk({clientID:"47d3a0c03f3c07172ecc",clientSecret:"8e0da02c5e757c77b93627a7e380e43a248d001c",repo:"HPDell.github.io",owner:"HPDell",admin:["HPDell"],labels:tags,id:new Date(1594155652e3).getTime()>new Date("2018-02-15").getTime()?md5(encodeURI(decodeURI(location.href))):location.href});gitalk.render("comment-container")</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>!function(n){var o=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(t,e){var n=new Image,o=t.getAttribute("data-original");n.onload=function(){t.src=o,e&&e()},n.src=o}function c(){for(var t=0;t<o.length;t++)0<=(e=o[t].getBoundingClientRect()).top&&0<=e.left&&e.top<=(n.innerHeight||document.documentElement.clientHeight)&&i(o[t],function(){o.splice(t,t)});var e;console.log("trigger")}c(),n.addEventListener("scroll",function(){var t,e;t=c,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html>