<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><title>Node.js 实现阿里云域名的动态解析 | 我们在小孩和大人的转角盖一座城堡</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="hpdell"><meta name="designer" content="minfive"><meta name="keywords" content="undefined"><meta name="description" content="HPDell 的博客"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://hpdell.github.io/编程/nodejs-ddns/index.html"><link rel="icon" type="image/png" href="/assets/img/avatar.jpg" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="HPDell 的个人博客"><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart=""><div id="page-loading" class="page page-loading" style="background-image:url(undefined)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="HPDell 的个人博客" alt="HPDell 的个人博客"><img src="/assets/img/avatar.jpg" alt="HPDell 的个人博客"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/assets/cover/nodejs-ddns.jpg" alt="Node.js 实现阿里云域名的动态解析"></div><header class="post__info"><h1 class="post__title">Node.js 实现阿里云域名的动态解析</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/">HPDell</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2019-02-16</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Node-js/">Node.js</a></li></ul></div></div></header><div class="post__content"><p>家用宽带申请公网 IP 往往是动态的公网 IP ，会经常变动，只能借助域名和 DDNS 使服务器可以随时被访问。 使用 Node.js 做 DDNS 也很简单，借助阿里云的 <a href="https://api.aliyun.com/#/" target="_blank" rel="noopener">OpenAPI Explorer</a> 可以做一个简单实现。 <a id="more"></a></p><h1 id="在线查找域名解析记录的-RecordID"><a href="#在线查找域名解析记录的-RecordID" class="headerlink" title="在线查找域名解析记录的 RecordID"></a>在线查找域名解析记录的 RecordID</h1><p>这步没有必要每次都用代码实现，因为域名解析记录的 ID 在修改的过程中是不会发生变化的。 所以直接通过 OpenAPI Explorer 来在线查询 RecordID 即可。</p><p>首先在 OpenAPI Explorer 中选择“云解析”的接口，找到 <code>DescribeDomainRecords</code> 接口，填入指定的参数， 点击“发起调用”，即可看到所有的域名解析记录。</p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="/编程/nodejs-ddns/describe-domain-records.png"><blockquote><p>参数栏中， <code>DomainName</code> 一处填写要修改解析记录的域名。右侧找到要修改的域名记录，记下 <code>RecordID</code> 。</p></blockquote><h1 id="动态修改域名解析记录"><a href="#动态修改域名解析记录" class="headerlink" title="动态修改域名解析记录"></a>动态修改域名解析记录</h1><p>这里需要借助以下三个接口：</p><ul><li>淘宝查询公网 IP 地址的接口。地址是 <a href="http://www.taobao.com/help/getip.php" target="_blank" rel="noopener">http://www.taobao.com/help/getip.php</a></li><li>阿里云 <code>DescribeDomainRecordInfo</code> 接口</li><li>阿里云 <code>UpdateDomainRecord</code> 接口</li></ul><p>淘宝的接口用 <code>Axios</code> 库调用，阿里云的两个接口可以通过阿里云提供的 <a href="https://www.npmjs.com/package/@alicloud/pop-core" target="_blank" rel="noopener">SDK</a> 调用。</p><h2 id="包的引入和对象声明"><a href="#包的引入和对象声明" class="headerlink" title="包的引入和对象声明"></a>包的引入和对象声明</h2><p>这部分引入包，并声明一些变量，以便后面调用。</p><table><thead><tr><th>参数</th><th>含义</th></tr></thead><tbody><tr><td><code>newIP</code></td><td>新的 IP 地址</td></tr><tr><td><code>client</code></td><td>阿里云 SDK 对象</td></tr><tr><td><code>describeDomainRecordInfoParams</code></td><td>调用 <code>DescribeDomainRecordInfo</code> 接口的参数</td></tr><tr><td><code>updateDomainRecordParams</code></td><td>调用 <code>UpdateDomainRecord</code> 接口的参数</td></tr><tr><td><code>requestOption</code></td><td>阿里云 SDK 请求配置</td></tr></tbody></table><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Core = <span class="built_in">require</span>(<span class="string">'@alicloud/pop-core'</span>);</span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">'axios'</span>).default;</span><br><span class="line"><span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">'moment'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> newIP = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> Core(&#123;</span><br><span class="line">    accessKeyId: <span class="string">'&lt;accessKeyId&gt;'</span>,</span><br><span class="line">    accessKeySecret: <span class="string">'&lt;accessKeySecret&gt;'</span>,</span><br><span class="line">    endpoint: <span class="string">'https://alidns.aliyuncs.com'</span>,</span><br><span class="line">    apiVersion: <span class="string">'2015-01-09'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> describeDomainRecordInfoParams = &#123;</span><br><span class="line">    <span class="string">"RecordId"</span>: <span class="string">"&lt;RecordId&gt;"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> updateDomainRecordParams = &#123;</span><br><span class="line">    <span class="string">"RecordId"</span>: <span class="string">"&lt;RecordId&gt;"</span>,</span><br><span class="line">    <span class="string">"RR"</span>: <span class="string">"@"</span>,</span><br><span class="line">    <span class="string">"Type"</span>: <span class="string">"A"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> requestOption = &#123;</span><br><span class="line">    method: <span class="string">'POST'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="查询当前公网-IP-地址"><a href="#查询当前公网-IP-地址" class="headerlink" title="查询当前公网 IP 地址"></a>查询当前公网 IP 地址</h2><p>调用淘宝接口进行查询，结果用正则表达式进行匹配。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">axios.get(<span class="string">"http://www.taobao.com/help/getip.php?t="</span> + moment().format(<span class="string">"x"</span>)).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (response.data) &#123;</span><br><span class="line">        <span class="keyword">var</span> matched = <span class="regexp">/(\d&#123;1,3&#125;\.)&#123;3&#125;\d&#123;1,3&#125;/</span>.exec(response.data);</span><br><span class="line">        <span class="keyword">if</span> (matched &amp;&amp; matched.length) &#123;</span><br><span class="line">            newIP = matched[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ......</span></span><br><span class="line">&#125;).catch(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">"Get public IPv4 error:"</span>, reason);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>匹配IP地址的正则表达式的写法不止 <code>/(\d{1,3}\.){3}\d{1,3}/</code> 这一种。 可以用更简化但匹配范围更广的写法，或用更严格的写法，只要达到目的即可。</p><h2 id="查询域名解析记录中记录的-IP-地址"><a href="#查询域名解析记录中记录的-IP-地址" class="headerlink" title="查询域名解析记录中记录的 IP 地址"></a>查询域名解析记录中记录的 IP 地址</h2><p>调用阿里云接口，将结果与当前公网 IP 进行对比。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">client.request(<span class="string">"DescribeDomainRecordInfo"</span>, describeDomainRecordInfoParams, requestOption).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> oldIP = result.Value;</span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">&#125;).catch(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">"DescribeDomainRecordInfo error:"</span>, reason);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h2 id="修改解析记录"><a href="#修改解析记录" class="headerlink" title="修改解析记录"></a>修改解析记录</h2><p>如果当前公网 IP 发生了变化，那么调用接口修改解析记录。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (oldIP != newIP) &#123;</span><br><span class="line">    updateDomainRecordParams = &#123;</span><br><span class="line">        ...updateDomainRecordParams,</span><br><span class="line">        <span class="string">"Value"</span>: newIP</span><br><span class="line">    &#125;;</span><br><span class="line">    client.request(<span class="string">"UpdateDomainRecord"</span>, updateDomainRecordParams, requestOption).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        process.exit(<span class="number">0</span>);</span><br><span class="line">    &#125;).catch(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">"UpdateDomainRecord error:"</span>, reason);</span><br><span class="line">        process.exit(<span class="number">1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>修改成功可以做一个输出，也可以不要。</p><blockquote><p>如果修改前后解析记录相同，则阿里云接口会返回一个字段 <code>Message</code> ， 值为 <code>The DNS record already exists</code> 。但是对于整个过程没有什么影响，因此没有对此错误进行处理。 但是为了避免频繁调用 API ，还是应该在调用接口发现 IP 地址发生变化之后再调用修改解析记录的接口。</p></blockquote><h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Core = <span class="built_in">require</span>(<span class="string">'@alicloud/pop-core'</span>);</span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">'axios'</span>).default;</span><br><span class="line"><span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">'moment'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> newIP = <span class="string">"127.0.0.1"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> client = <span class="keyword">new</span> Core(&#123;</span><br><span class="line">    accessKeyId: <span class="string">'&lt;accessKeyId&gt;'</span>,</span><br><span class="line">    accessKeySecret: <span class="string">'&lt;accessKeySecret&gt;'</span>,</span><br><span class="line">    endpoint: <span class="string">'https://alidns.aliyuncs.com'</span>,</span><br><span class="line">    apiVersion: <span class="string">'2015-01-09'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> describeDomainRecordInfoParams = &#123;</span><br><span class="line">    <span class="string">"RecordId"</span>: <span class="string">"&lt;RecordId&gt;"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> updateDomainRecordParams = &#123;</span><br><span class="line">    <span class="string">"RecordId"</span>: <span class="string">"&lt;RecordId&gt;"</span>,</span><br><span class="line">    <span class="string">"RR"</span>: <span class="string">"@"</span>,</span><br><span class="line">    <span class="string">"Type"</span>: <span class="string">"A"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> requestOption = &#123;</span><br><span class="line">    method: <span class="string">'POST'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">axios.get(<span class="string">"http://www.taobao.com/help/getip.php?t="</span> + moment().format(<span class="string">"x"</span>)).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (response.data) &#123;</span><br><span class="line">        <span class="keyword">var</span> matched = <span class="regexp">/(\d&#123;1,3&#125;\.)&#123;3&#125;\d&#123;1,3&#125;/</span>.exec(response.data);</span><br><span class="line">        <span class="keyword">if</span> (matched &amp;&amp; matched.length) &#123;</span><br><span class="line">            newIP = matched[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        client.request(<span class="string">"DescribeDomainRecordInfo"</span>, describeDomainRecordInfoParams, requestOption).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> oldIP = result.Value;</span><br><span class="line">            <span class="keyword">if</span> (oldIP != newIP) &#123;</span><br><span class="line">                updateDomainRecordParams = &#123;</span><br><span class="line">                    ...updateDomainRecordParams,</span><br><span class="line">                    <span class="string">"Value"</span>: newIP</span><br><span class="line">                &#125;;</span><br><span class="line">                client.request(<span class="string">"UpdateDomainRecord"</span>, updateDomainRecordParams, requestOption).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    process.exit(<span class="number">0</span>);</span><br><span class="line">                &#125;).catch(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">                    <span class="built_in">console</span>.error(<span class="string">"UpdateDomainRecord error:"</span>, reason);</span><br><span class="line">                    process.exit(<span class="number">1</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).catch(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.error(<span class="string">"DescribeDomainRecordInfo error:"</span>, reason);</span><br><span class="line">            process.exit(<span class="number">1</span>);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).catch(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.error(<span class="string">"Get public IPv4 error:"</span>, reason);</span><br><span class="line">    process.exit(<span class="number">1</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h1 id="基于-Docker-服务化"><a href="#基于-Docker-服务化" class="headerlink" title="基于 Docker 服务化"></a>基于 Docker 服务化</h1><p>在威联通等一些 NAS 系统上，系统本身提供了获取 IP 地址的功能，而且支持向 DDNS 服务器发送请求以更改 IP 地址。 一些路由器固件中已经内置了修改阿里云 DNS 解析记录的功能，但是威联通自带的 DDNS 并不支持直接修改阿里云 DNS。 但是威联通支持通过自定义 DDNS 请求，请求中可通过 <code>%IP%</code> 字符串代替当前 IP 地址，例如这样的一个请求：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://ddns.ddd.qnap.net/?hostname=%HOST%&amp;username=%USER%&amp;password=%PASS%&amp;IP=%IP%</span><br></pre></td></tr></table></figure><p>因此我们可以将上述 DDNS 代码通过构建 Docker 镜像发布成服务，使威联通 NAS 通过该服务修改 DNS 解析记录。</p><h2 id="服务接口实现"><a href="#服务接口实现" class="headerlink" title="服务接口实现"></a>服务接口实现</h2><p>要实现一个网络服务接口，方法很多。因为对 Node.js 比较熟，笔者这里采用了 Express 服务器框架。 总体来说，只需要写一个路由即可。 阿里云 API 所需要的 ACCESSKEY_ID 和 ACCESSKEY_SECRET 通过环境变量进行设置。 为了支持多个域名的 DDNS 而不需要部署过多的 Docker 容器，RecordID、Type、RR、IP 等参数都从请求地址中获取。</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routes/ddns.js</span></span><br><span class="line"><span class="keyword">const</span> Core = <span class="built_in">require</span>(<span class="string">'@alicloud/pop-core'</span>);</span><br><span class="line"><span class="keyword">const</span> axios = <span class="built_in">require</span>(<span class="string">'axios'</span>).default;</span><br><span class="line"><span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">'moment'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">updateDNS</span>(<span class="params">ip, record, type, rr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> client = <span class="keyword">new</span> Core(&#123;</span><br><span class="line">        accessKeyId: process.env.ACCESSKEY_ID,</span><br><span class="line">        accessKeySecret: process.env.ACCESSKEY_SECRET,</span><br><span class="line">        endpoint: <span class="string">'https://alidns.aliyuncs.com'</span>,</span><br><span class="line">        apiVersion: <span class="string">'2015-01-09'</span></span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">var</span> describeDomainRecordInfoParams = &#123;</span><br><span class="line">        <span class="string">"RecordId"</span>: record</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">var</span> requestOption = &#123;</span><br><span class="line">        method: <span class="string">"POST"</span></span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">        client.request(<span class="string">"DescribeDomainRecordInfo"</span>, describeDomainRecordInfoParams, requestOption).then(<span class="function">(<span class="params">result</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> oldIP = result.Value;</span><br><span class="line">            <span class="keyword">if</span> (oldIP != ip) &#123;</span><br><span class="line">                <span class="keyword">var</span> updateDomainRecordParams = &#123;</span><br><span class="line">                    <span class="string">"RecordId"</span>: record,</span><br><span class="line">                    <span class="string">"RR"</span>: rr,</span><br><span class="line">                    <span class="string">"Type"</span>: type,</span><br><span class="line">                    <span class="string">"Value"</span>: ip</span><br><span class="line">                &#125;;</span><br><span class="line">                client.request(<span class="string">"UpdateDomainRecord"</span>, updateDomainRecordParams, requestOption).then(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    resolve(<span class="string">"OK"</span>);</span><br><span class="line">                &#125;).catch(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">                    reject(<span class="string">"UpdateDomainRecord error: "</span> + reason);</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).catch(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">            reject(<span class="string">"DescribeDomainRecordInfo error: "</span> + reason);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/qnap'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> query_keys = [<span class="string">"ip"</span>, <span class="string">"record"</span>, <span class="string">"type"</span>, <span class="string">"rr"</span>];</span><br><span class="line">    <span class="keyword">var</span> query_keys_check = query_keys.every(<span class="function"><span class="params">item</span> =&gt;</span> (item <span class="keyword">in</span> req.query));</span><br><span class="line">    <span class="keyword">if</span> (!query_keys_check) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">"Missing:"</span>, query_keys.filter(<span class="function"><span class="params">item</span> =&gt;</span> !(item <span class="keyword">in</span> req.query)).join(<span class="string">","</span>));</span><br><span class="line">        res.sendStatus(<span class="number">500</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(req.query);</span><br><span class="line">    <span class="keyword">var</span> newIP = req.query.ip;</span><br><span class="line">    <span class="keyword">var</span> recordID = req.query.record;</span><br><span class="line">    <span class="keyword">var</span> recordType = req.query.type;</span><br><span class="line">    <span class="keyword">var</span> recordRR = req.query.rr;</span><br><span class="line">    updateDNS(newIP, recordID, recordType, recordRR).then(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(response);</span><br><span class="line">        res.sendStatus(<span class="number">200</span>);</span><br><span class="line">    &#125;).catch(<span class="function">(<span class="params">reason</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(reason);</span><br><span class="line">        res.sendStatus(<span class="number">500</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure><p>当然这里也可以添加一个自动获取 IP 地址并更新 DNS 解析记录的接口。</p><p>实现服务器后，只需要写一个简单的 Dockerfile 即可。</p><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> . /srv</span></span><br><span class="line"><span class="bash">WORKDIR /srv</span></span><br><span class="line"><span class="bash">RUN npm install</span></span><br><span class="line"><span class="bash">EXPOSE 3000</span></span><br><span class="line"><span class="bash"></span></span><br><span class="line"><span class="bash">CMD [ <span class="string">"node"</span>, <span class="string">"bin/www"</span> ]</span></span><br></pre></td></tr></table></figure><p>具体实现请参考 <a href="https://github.com/HPDell/aliyun-ddns" target="_blank" rel="noopener">Github 仓库</a>。</p><div class="post-announce">感谢您的阅读，本文由 <a href="http://hpdell.github.io">HPDell 的个人博客</a> 版权所有。如若转载，请注明出处：HPDell 的个人博客（<a href="http://hpdell.github.io/编程/nodejs-ddns/">http://hpdell.github.io/编程/nodejs-ddns/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/随笔/fantasy-movies/" title="Common Connotations of Western Fantasy Movies"><i class="iconfont icon-prev"></i>Common Connotations of Western Fantasy Movies</a></div><div class="post__prev post__prev--right"><a href="/随笔/la-la-land/" title="《爱乐之城》的“过度”解读">《爱乐之城》的“过度”解读<i class="iconfont icon-next"></i></a></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">HPDell 的博客</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/随笔/">随笔</a><span class="block-list-count">9</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/编程/">编程</a><span class="block-list-count">24</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/理论/">理论</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/其他/">其他</a><span class="block-list-count">5</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/编程/dynamic-blog-v2/" title="自己动手写动态博客（二）"><div class="item__cover"><img src="/assets/cover/dynamic-blog-v2.png" alt="自己动手写动态博客（二）"></div><div class="item__info"><h3 class="item__title">自己动手写动态博客（二）</h3><span class="item__text">2022-03-20</span></div></a></li><li class="latest-post-item"><a href="/编程/windows-cmd-mklink/" title="Windows 创建符号链接的命令 mklink"><div class="item__cover"><img src="/assets/img/header_cover.jpg" alt="Windows 创建符号链接的命令 mklink"></div><div class="item__info"><h3 class="item__title">Windows 创建符号链接的命令 mklink</h3><span class="item__text">2022-01-19</span></div></a></li><li class="latest-post-item"><a href="/随笔/wind-from-luoyang/" title="《风起洛阳》观后感"><div class="item__cover"><img src="/assets/cover/wind-from-luoyang.jpg" alt="《风起洛阳》观后感"></div><div class="item__info"><h3 class="item__title">《风起洛阳》观后感</h3><span class="item__text">2021-12-31</span></div></a></li><li class="latest-post-item"><a href="/随笔/only-and-forever/" title="《一生一世》观后感"><div class="item__cover"><img src="/assets/cover/forever-and-ever.jpg" alt="《一生一世》观后感"></div><div class="item__info"><h3 class="item__title">《一生一世》观后感</h3><span class="item__text">2021-11-04</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Apache-POI/">Apache POI</a></li><li class="tag-item"><a class="tag-link" href="/tags/Bootstrap/">Bootstrap</a></li><li class="tag-item"><a class="tag-link" href="/tags/C/">C#</a></li><li class="tag-item"><a class="tag-link" href="/tags/CUDA/">CUDA</a></li><li class="tag-item"><a class="tag-link" href="/tags/Django/">Django</a></li><li class="tag-item"><a class="tag-link" href="/tags/GitLab-Runner/">GitLab Runner</a></li><li class="tag-item"><a class="tag-link" href="/tags/LaTeX/">LaTeX</a></li><li class="tag-item"><a class="tag-link" href="/tags/Linux/">Linux</a></li><li class="tag-item"><a class="tag-link" href="/tags/Node-js/">Node.js</a></li><li class="tag-item"><a class="tag-link" href="/tags/Python/">Python</a></li><li class="tag-item"><a class="tag-link" href="/tags/QGIS/">QGIS</a></li><li class="tag-item"><a class="tag-link" href="/tags/Qt/">Qt</a></li><li class="tag-item"><a class="tag-link" href="/tags/R/">R</a></li><li class="tag-item"><a class="tag-link" href="/tags/TypeScript/">TypeScript</a></li><li class="tag-item"><a class="tag-link" href="/tags/Vue/">Vue</a></li><li class="tag-item"><a class="tag-link" href="/tags/WPF/">WPF</a></li><li class="tag-item"><a class="tag-link" href="/tags/Windows/">Windows</a></li><li class="tag-item"><a class="tag-link" href="/tags/XAML/">XAML</a></li><li class="tag-item"><a class="tag-link" href="/tags/jQuery-Mobile/">jQuery Mobile</a></li><li class="tag-item"><a class="tag-link" href="/tags/travis/">travis</a></li><li class="tag-item"><a class="tag-link" href="/tags/博客相关/">博客相关</a></li><li class="tag-item"><a class="tag-link" href="/tags/原神/">原神</a></li><li class="tag-item"><a class="tag-link" href="/tags/哈利波特/">哈利波特</a></li><li class="tag-item"><a class="tag-link" href="/tags/影评/">影评</a></li><li class="tag-item"><a class="tag-link" href="/tags/测试/">测试</a></li><li class="tag-item"><a class="tag-link" href="/tags/爬虫/">爬虫</a></li><li class="tag-item"><a class="tag-link" href="/tags/电影/">电影</a></li><li class="tag-item"><a class="tag-link" href="/tags/统计学/">统计学</a></li><li class="tag-item"><a class="tag-link" href="/tags/网页开发/">网页开发</a></li><li class="tag-item"><a class="tag-link" href="/tags/课程/">课程</a></li><li class="tag-item"><a class="tag-link" href="/tags/路网速度/">路网速度</a></li><li class="tag-item"><a class="tag-link" href="/tags/随笔/">随笔</a></li></ul></div><div class="sidebar__block__sticky"><h3 class="block__title">目录</h3><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#在线查找域名解析记录的-RecordID"><span class="toc-text">在线查找域名解析记录的 RecordID</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#动态修改域名解析记录"><span class="toc-text">动态修改域名解析记录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#包的引入和对象声明"><span class="toc-text">包的引入和对象声明</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询当前公网-IP-地址"><span class="toc-text">查询当前公网 IP 地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询域名解析记录中记录的-IP-地址"><span class="toc-text">查询域名解析记录中记录的 IP 地址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#修改解析记录"><span class="toc-text">修改解析记录</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#完整代码"><span class="toc-text">完整代码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#基于-Docker-服务化"><span class="toc-text">基于 Docker 服务化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#服务接口实现"><span class="toc-text">服务接口实现</span></a></li></ol></li></ol></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">HPDell的博客，基于Hexo。分享生活，分享技术，分享观点，为自己留下感动。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Wuhan University, Luoyu Road, Wuhan, Hubei, China.</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>huyg0180110559@outlook.com</span></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">友情链接</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://blog.huyg.site:8443/" title="我的动态博客" target="_blank">我的动态博客</a></li><li class="list-item"><a href="https://hkvision.cn/" title="HaoKunT的博客" target="_blank">HaoKunT的博客</a></li><li class="list-item"><a href="https://home.cs-tao.cc/" title="这是一个不能停留太久的世界" target="_blank">CS-Tao</a></li><li class="list-item"><a href="http://gwmodel.whu.edu.cn/#/" title="地理加权建模实验室" target="_blank">GWmodel-Lab</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/HPDell" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:huyg0180110559@outlook.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li><li class="social-network__item"><a href="https://www.zhihu.com/people/hu-yi-gong-63/activities" target="_blank" title="知乎"><i class="iconfont icon-zhihu"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var tags=["Node.js"],gitalk=new Gitalk({clientID:"47d3a0c03f3c07172ecc",clientSecret:"8e0da02c5e757c77b93627a7e380e43a248d001c",repo:"HPDell.github.io",owner:"HPDell",admin:["HPDell"],labels:tags,id:new Date(1550349772e3).getTime()>new Date("2018-02-15").getTime()?md5(encodeURI(decodeURI(location.href))):location.href});gitalk.render("comment-container")</script><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>!function(n){var o=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function i(t,e){var n=new Image,o=t.getAttribute("data-original");n.onload=function(){t.src=o,e&&e()},n.src=o}function c(){for(var t=0;t<o.length;t++)0<=(e=o[t].getBoundingClientRect()).top&&0<=e.left&&e.top<=(n.innerHeight||document.documentElement.clientHeight)&&i(o[t],function(){o.splice(t,t)});var e;console.log("trigger")}c(),n.addEventListener("scroll",function(){var t,e;t=c,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this)</script></body></html>